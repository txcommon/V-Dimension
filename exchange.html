<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title data-i18n="exchange.pageTitle">å…‘æ¢ä¸­å¿ƒ</title>
	<link rel="icon" href="./favicon.ico" type="image/x-icon">
	<link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #0a0520 0%, #1a0b3d 50%, #2d1055 100%); min-height: 100vh; color: #fff; overflow-x: hidden; position: relative; }

        /* æ˜Ÿç©ºèƒŒæ™¯ */
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        /* é¡¶éƒ¨å¯¼èˆª */
        .top-nav { position: sticky; top: 0; z-index: 100; background: rgba(10, 5, 32, 0.8); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(168, 85, 247, 0.2); padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; }
        .nav-left { display: flex; align-items: center; gap: 12px; }
        .back-btn { width: 36px; height: 36px; border-radius: 12px; background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; color: #a855f7; font-size: 18px; }
        .back-btn:active { transform: scale(0.95); }
        .nav-title { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, #fb923c 0%, #f59e0b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .refresh-btn { width: 36px; height: 36px; border-radius: 12px; background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; font-size: 18px; }
        .refresh-btn:active { transform: scale(0.95); }
        .refresh-btn.spinning { animation: spin 0.5s linear; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* ä¸»å®¹å™¨ */
        .container { position: relative; z-index: 1; max-width: 640px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }

        /* Tabæ»‘åŠ¨å¯¼èˆª */
        .tab-scroll-container { overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; scrollbar-width: none; margin-bottom: 20px; }
        .tab-scroll-container::-webkit-scrollbar { display: none; }
        .tab-nav { display: flex; gap: 12px; padding: 6px; background: rgba(255, 255, 255, 0.03); border-radius: 16px; border: 1px solid rgba(168, 85, 247, 0.2); min-width: max-content; }
        .tab-item { padding: 12px 20px; border-radius: 12px; font-size: 15px; font-weight: 600; text-align: center; cursor: pointer; transition: all 0.3s; border: 1px solid transparent; white-space: nowrap; min-width: 140px; color: rgba(255, 255, 255, 0.8); }
        .tab-item:active { transform: scale(0.98); }
        .tab-item.active { background: linear-gradient(135deg, rgba(168, 85, 247, 0.3) 0%, rgba(217, 70, 239, 0.3) 100%); border-color: rgba(168, 85, 247, 0.5); box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3); color: #fff; }

        /* å…‘æ¢å¡ç‰‡ */
        .exchange-card { display: none; background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(217, 70, 239, 0.15) 100%); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 24px; padding: 24px; position: relative; overflow: hidden; backdrop-filter: blur(20px); }
        .exchange-card.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .exchange-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(168, 85, 247, 0.1) 0%, transparent 70%); animation: pulse 3s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }
        .card-content { position: relative; z-index: 1; }

        /* å…‘æ¢ä¿¡æ¯åŒº */
        .exchange-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .info-title { font-size: 16px; color: rgba(255, 255, 255, 0.85); display: flex; align-items: center; gap: 6px; }
        .balance-display { font-size: 15px; color: rgba(255, 255, 255, 0.75); }
        .balance-label { margin-right: 4px; }
        .balance-value { color: rgba(255, 255, 255, 0.9); font-weight: 600; }

        .exchange-row { background: rgba(0, 0, 0, 0.3); border-radius: 16px; padding: 20px 20px 8px 20px; margin-bottom: 20px; display: flex; flex-wrap: wrap; align-items: flex-end; justify-content: center; gap: 6px; }
        .exchange-item { display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .exchange-label { font-size: 14px; color: rgba(255, 255, 255, 0.8); }
        .exchange-amount { font-size: 24px; font-weight: 800; color: #fff; }
        .exchange-amount-orange { background: linear-gradient(135deg, #fb923c 0%, #f59e0b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px rgba(251, 146, 60, 0.5); }
        .exchange-arrow-icon { font-size: 24px; color: #a855f7; }
        .contract-balance-inline { width: 100%; text-align: center; margin-top: 6px; font-size: 14px; color: #fb923c; font-weight: 500; }
        .contract-balance-inline span { font-weight: 600; }

        /* å…‘æ¢æŒ‰é’® */
        .exchange-btn { width: 100%; padding: 16px; border-radius: 16px; border: none; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; margin-bottom: 16px; }
        .exchange-btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255, 255, 255, 0.3); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
        .exchange-btn:active::before { width: 300px; height: 300px; }
        .btn-enabled { background: linear-gradient(135deg, #fb923c 0%, #f59e0b 100%); color: #000; box-shadow: 0 8px 24px rgba(251, 146, 60, 0.4); }
        .btn-enabled:active { transform: scale(0.98); }
        .btn-disabled { background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.5); cursor: not-allowed; }
        .btn-warning { background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%); color: #fff; box-shadow: 0 8px 24px rgba(168, 85, 247, 0.4); }
        .btn-text { position: relative; z-index: 1; }

        /* æ¡ä»¶æ£€æŸ¥åŒº */
        .conditions { margin-bottom: 20px; }
        .conditions-title { font-size: 16px; color: rgba(255, 255, 255, 0.85); margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
        .condition-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: rgba(255, 255, 255, 0.06); border-radius: 12px; margin-bottom: 8px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .condition-label { font-size: 15px; color: rgba(255, 255, 255, 0.9); display: flex; align-items: center; gap: 8px; }
        .condition-status { font-size: 14px; font-weight: 600; padding: 4px 10px; border-radius: 8px; }
        .status-fail { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status-countdown { background: rgba(251, 146, 60, 0.2); color: #fb923c; font-family: 'Courier New', monospace; min-width: 120px; text-align: center; animation: pulse-soft 2s ease-in-out infinite; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .status-ready { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .all-conditions-met { text-align: center; padding: 16px; color: #10b981; font-weight: 600; font-size: 15px; text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }

        /* é…é¢è¿›åº¦æ¡ */
        .quota-progress { margin: 16px 0; padding: 16px; background: rgba(10, 5, 30, 0.6); border-radius: 12px; border: 1px solid rgba(168, 85, 247, 0.35); }
        .quota-title { font-size: 15px; color: rgba(255, 255, 255, 0.9); margin-bottom: 8px; font-weight: 600; }
        .progress-bar { height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 6px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { height: 100%; border-radius: 6px; transition: width 0.8s ease; }
        .progress-green { background: linear-gradient(90deg, #10b981 0%, #34d399 100%); }
        .progress-yellow { background: linear-gradient(90deg, #fbbf24 0%, #fcd34d 100%); }
        .progress-red { background: linear-gradient(90deg, #ef4444 0%, #f87171 100%); }
        .quota-stats { display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .quota-used { color: #fff; font-weight: 600; }
        .quota-percent { color: rgba(255, 255, 255, 0.8); font-weight: 600; }
        .quota-unlocked { text-align: center; padding: 12px; color: #10b981; font-weight: 600; font-size: 15px; text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }

        /* æç¤ºä¿¡æ¯ */
        .tip-box { margin-top: 16px; padding: 14px 18px; background: rgba(251, 191, 36, 0.15); border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 12px; }
        .tip-title { font-size: 14px; color: #fcd34d; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; text-shadow: 0 0 10px rgba(251, 191, 36, 0.6); }
        .tip-content { font-size: 14px; color: #fde68a; line-height: 1.7; text-shadow: 0 0 8px rgba(251, 191, 36, 0.3); }

        /* åº•éƒ¨å¯¼èˆª */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; padding: 12px 0 20px; background: rgba(26, 11, 61, 0.8); backdrop-filter: blur(20px); border-top: 1px solid rgba(168, 85, 247, 0.2); box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.3); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; padding: 8px 16px; border-radius: 12px; transition: all 0.3s; }
        .nav-item.active { background: rgba(168, 85, 247, 0.15); }
        .nav-icon { font-size: 24px; transition: all 0.3s; }
        .nav-item.active .nav-icon { color: #a855f7; transform: scale(1.1); }
        .nav-item:not(.active) .nav-icon { color: rgba(255, 255, 255, 0.4); }
        .nav-label { font-size: 11px; font-weight: 600; transition: all 0.3s; }
        .nav-item.active .nav-label { color: #a855f7; }
        .nav-item:not(.active) .nav-label { color: rgba(255, 255, 255, 0.4); }

        /* Loading & Toast */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .loading-overlay.show { display: flex; }
        .loading-content { text-align: center; color: #fff; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(168, 85, 247, 0.3); border-top-color: #a855f7; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        .loading-text { font-size: 14px; }
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 16px 24px; border-radius: 12px; font-size: 14px; font-weight: 600; z-index: 10000; animation: toastIn 0.3s ease; }
        .toast-success { background: rgba(16, 185, 129, 0.9); color: #fff; }
        .toast-error { background: rgba(239, 68, 68, 0.9); color: #fff; }
        @keyframes toastIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
    </style>
</head>
<body>
    <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
    <div class="stars" id="stars"></div>

    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="top-nav">
        <div class="nav-left">
            <div class="back-btn" onclick="goBack()">â†</div>
            <div class="nav-title">ğŸ’± å…‘æ¢ä¸­å¿ƒ</div>
        </div>
        <div class="refresh-btn" id="refreshBtn" onclick="refreshData()">ğŸ”„</div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        
        <!-- Tabæ»‘åŠ¨å¯¼èˆª -->
        <div class="tab-scroll-container">
            <div class="tab-nav">
                <div class="tab-item active" onclick="switchTab('usdt-vid')">USDTå…‘æ¢VID</div>
                <div class="tab-item" onclick="switchTab('vollar-bnb')">Vollarå…‘æ¢BNB</div>
                <div class="tab-item" onclick="switchTab('vollar-usdt')">Vollarå…‘æ¢USDT</div>
                <div class="tab-item" onclick="switchTab('vollar-vid')">Vollarå…‘æ¢VID</div>
            </div>
        </div>

        <!-- USDT â†’ VID å…‘æ¢å¡ç‰‡ -->
        <div class="exchange-card active" id="card-usdt-vid">
            <div class="card-content">
                <div class="exchange-header">
                    
                    <div class="balance-display">
                        <span class="balance-label">ğŸ’° æˆ‘çš„ä½™é¢:</span>
                        <span class="balance-value" id="usdt-balance">0.00</span> USDT
                    </div>
                </div>

                <div class="exchange-row">
                    <div class="exchange-item">
                        <div class="exchange-label">æ”¯ä»˜ USDT</div>
                        <div class="exchange-amount exchange-amount-orange" id="usdt-pay">500</div>
                    </div>
                    <div class="exchange-arrow-icon">â†’</div>
                    <div class="exchange-item">
                        <div class="exchange-label">è·å¾— VID</div>
                        <div class="exchange-amount exchange-amount-orange" id="usdt-receive">50</div>
                    </div>
                    <div class="contract-balance-inline">ğŸ’°åˆçº¦ä½™é¢: <span id="contract-vid-0">0</span> VID</div>
                </div>

                <button class="exchange-btn btn-disabled" id="btn-usdt-vid" onclick="handleExchange('usdt-vid')">
                    <span class="btn-text" id="btn-text-usdt-vid">æ¡ä»¶æœªæ»¡è¶³</span>
                </button>

                <div class="conditions" id="conditions-usdt-vid"></div>

                <div class="quota-progress" id="quota-usdt-vid">
                    <div class="quota-title">ğŸ“¦ VID é…é¢ä½¿ç”¨</div>
                    <div class="progress-bar"><div class="progress-fill progress-green" id="quota-bar-vid" style="width: 0%"></div></div>
                    <div class="quota-stats">
                        <div class="quota-used"><span id="quota-used-vid">0</span> / <span id="quota-total-vid">0</span> VID</div>
                        <div class="quota-percent" id="quota-percent-vid">0.00%</div>
                    </div>
                </div>

                <div class="tip-box">
                    <div class="tip-title">ğŸ’¡ æ¸©é¦¨æç¤º</div>
                    <div class="tip-content">
                        â€¢ å…‘æ¢é—´éš”ï¼š8å°æ—¶<br>
                        â€¢ æµé€šé‡<2100ä¸‡ï¼šå›ºå®šå…‘æ¢1000U<br>
                        â€¢ æµé€šé‡â‰¥2100ä¸‡ï¼šå›ºå®šå…‘æ¢3000U<br>
                        â€¢ é…é¢ï¼šæµé€šé‡<333äº¿å—é…é¢é™åˆ¶
                    </div>
                </div>
            </div>
        </div>

        <!-- Vollar â†’ BNB å…‘æ¢å¡ç‰‡ -->
        <div class="exchange-card" id="card-vollar-bnb">
            <div class="card-content">
                <div class="exchange-header">
                    
                    <div class="balance-display">
                        <span class="balance-label">ğŸ’ æˆ‘çš„ä½™é¢:</span>
                        <span class="balance-value" id="vollar-bnb-balance">0.00</span> Vollar
                    </div>
                </div>

                <div class="exchange-row">
                    <div class="exchange-item">
                        <div class="exchange-label">é”€æ¯ Vollar</div>
                        <div class="exchange-amount exchange-amount-orange" id="vollar-bnb-burn">100</div>
                    </div>
                    <div class="exchange-arrow-icon">â†’</div>
                    <div class="exchange-item">
                        <div class="exchange-label">è·å¾— BNB</div>
                        <div class="exchange-amount exchange-amount-orange" id="bnb-receive">0.1</div>
                    </div>
                    <div class="contract-balance-inline">ğŸ’° åˆçº¦ä½™é¢: <span id="contract-bnb">0</span> BNB</div>
                </div>

                <button class="exchange-btn btn-disabled" id="btn-vollar-bnb" onclick="handleExchange('vollar-bnb')">
                    <span class="btn-text" id="btn-text-vollar-bnb">æ¡ä»¶æœªæ»¡è¶³</span>
                </button>

                <div class="conditions" id="conditions-vollar-bnb"></div>

                <div class="tip-box">
                    <div class="tip-title">ğŸ’¡ æ¸©é¦¨æç¤º</div>
                    <div class="tip-content">
                        â€¢ å…‘æ¢é—´éš”ï¼š30å¤©<br>
                        â€¢ å…‘æ¢é‡‘é¢ï¼š100Vollar Ã— ç¤¾åŒºå€ç‡<br>
                        â€¢ æ ¹æ®åˆçº¦BNBä½™é¢è‡ªåŠ¨è°ƒæ•´ï¼š<br>
                        &nbsp;&nbsp;â‰¥1000 BNB: æ­£å¸¸å…‘æ¢<br>
                        &nbsp;&nbsp;â‰¥300 BNB: å‡10å€<br>
                        &nbsp;&nbsp;â‰¥100 BNB: å‡20å€<br>
                        &nbsp;&nbsp;â‰¥30 BNB: å‡30å€<br>
                        &nbsp;&nbsp;<30 BNB: å‡100å€
                    </div>
                </div>
            </div>
        </div>

        <!-- Vollar â†’ USDT å…‘æ¢å¡ç‰‡ -->
        <div class="exchange-card" id="card-vollar-usdt">
            <div class="card-content">
                <div class="exchange-header">
                    
                    <div class="balance-display">
                        <span class="balance-label">ğŸ’ æˆ‘çš„ä½™é¢:</span>
                        <span class="balance-value" id="vollar-usdt-balance">0.00</span> Vollar
                    </div>
                </div>

                <div class="exchange-row">
                    <div class="exchange-item">
                        <div class="exchange-label">é”€æ¯ Vollar</div>
                        <div class="exchange-amount exchange-amount-orange" id="vollar-usdt-burn">500</div>
                    </div>
                    <div class="exchange-arrow-icon">â†’</div>
                    <div class="exchange-item">
                        <div class="exchange-label">è·å¾— USDT</div>
                        <div class="exchange-amount exchange-amount-orange" id="usdt-receive-2">500</div>
                    </div>
                    <div class="contract-balance-inline">ğŸ’° åˆçº¦ä½™é¢: <span id="contract-usdt">0</span> USDT</div>
                </div>

                <button class="exchange-btn btn-disabled" id="btn-vollar-usdt" onclick="handleExchange('vollar-usdt')">
                    <span class="btn-text" id="btn-text-vollar-usdt">æ¡ä»¶æœªæ»¡è¶³</span>
                </button>

                <div class="conditions" id="conditions-vollar-usdt"></div>

                <div class="quota-progress" id="quota-vollar-usdt">
                    <div class="quota-title">ğŸ“¦ USDT é…é¢ä½¿ç”¨</div>
                    <div class="progress-bar"><div class="progress-fill progress-green" id="quota-bar-usdt" style="width: 0%"></div></div>
                    <div class="quota-stats">
                        <div class="quota-used"><span id="quota-used-usdt">0</span> / <span id="quota-total-usdt">0</span> USDT</div>
                        <div class="quota-percent" id="quota-percent-usdt">0.00%</div>
                    </div>
                </div>

                <div class="tip-box">
                    <div class="tip-title">ğŸ’¡ æ¸©é¦¨æç¤º</div>
                    <div class="tip-content">
                        â€¢ å…‘æ¢é—´éš”ï¼š30å¤©<br>
                        â€¢ å…‘æ¢é‡‘é¢ï¼š500Vollar Ã— ç¤¾åŒºå€ç‡<br>
                        â€¢ æ ¹æ®åˆçº¦USDTä½™é¢è‡ªåŠ¨è°ƒæ•´ï¼š<br>
                        &nbsp;&nbsp;â‰¥3000ä¸‡: æ­£å¸¸å…‘æ¢<br>
                        &nbsp;&nbsp;â‰¥2000ä¸‡: å‡10å€<br>
                        &nbsp;&nbsp;â‰¥1000ä¸‡: å‡20å€<br>
                        &nbsp;&nbsp;â‰¥300ä¸‡: å‡30å€<br>
                        &nbsp;&nbsp;<300ä¸‡: å‡100å€
                    </div>
                </div>
            </div>
        </div>

        <!-- Vollar â†’ VID å…‘æ¢å¡ç‰‡ -->
        <div class="exchange-card" id="card-vollar-vid">
            <div class="card-content">
                <div class="exchange-header">
                    
                    <div class="balance-display">
                        <span class="balance-label">ğŸ’ æˆ‘çš„ä½™é¢:</span>
                        <span class="balance-value" id="vollar-vid-balance">0.00</span> Vollar
                    </div>
                </div>

                <div class="exchange-row">
                    <div class="exchange-item">
                        <div class="exchange-label">é”€æ¯ Vollar</div>
                        <div class="exchange-amount exchange-amount-orange">100,000</div>
                    </div>
                    <div class="exchange-arrow-icon">â†’</div>
                    <div class="exchange-item">
                        <div class="exchange-label">è·å¾— VID</div>
                        <div class="exchange-amount exchange-amount-orange" id="vid-receive-3">10,000</div>
                    </div>
                    <div class="contract-balance-inline">ğŸ’° åˆçº¦ä½™é¢: <span id="contract-vid-3">0</span> VID</div>
                </div>

                <button class="exchange-btn btn-disabled" id="btn-vollar-vid" onclick="handleExchange('vollar-vid')">
                    <span class="btn-text" id="btn-text-vollar-vid">æ¡ä»¶æœªæ»¡è¶³</span>
                </button>

                <div class="conditions" id="conditions-vollar-vid"></div>

                <div class="tip-box">
                    <div class="tip-title">ğŸ’¡ æ¸©é¦¨æç¤º</div>
                    <div class="tip-content">
                        â€¢ å…‘æ¢é—´éš”ï¼š30å¤©<br>
                        â€¢ å›ºå®šå…‘æ¢ï¼š100,000 Vollar<br>
                        â€¢ ä»…é™å…¥æ¦œç¤¾åŒºï¼ˆå‰100åï¼‰<br>
                        â€¢ æµé€šé‡éœ€è¾¾åˆ° 1000äº¿ Vollar
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="switchPage('home')" data-page="home"><div class="nav-icon">ğŸ </div><div class="nav-label" data-i18n="nav.home">é¦–é¡µ</div></div>
        <div class="nav-item" onclick="switchPage('stats')" data-page="stats"><div class="nav-icon">ğŸ“Š</div><div class="nav-label" data-i18n="nav.data">æ•°æ®</div></div>
        <div class="nav-item active" onclick="switchPage('swap')" data-page="swap"><div class="nav-icon">ğŸ’°</div><div class="nav-label" data-i18n="nav.exchange">å…‘æ¢</div></div>
        <div class="nav-item" onclick="switchPage('temple')" data-page="temple"><div class="nav-icon">ğŸ›ï¸</div><div class="nav-label" data-i18n="nav.temple">åœ£æ®¿</div></div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/web3-manager.js"></script>
    <script>
        // ========== å¸¸é‡ ==========
        const REMIN_TIME = 8 * 3600;      // 8å°æ—¶
        const REMAX_TIME = 30 * 86400;    // 30å¤©
        const BASE_SUPPLY = 21e12;        // 2100ä¸‡ (6ä½ç²¾åº¦)
        const BASE_BILLION = 1e14;        // 1äº¿ (6ä½ç²¾åº¦)
        const SUPPLY_333B = 333e14;       // 333äº¿ (6ä½ç²¾åº¦)
        const SUPPLY_1000B = 1000e14;     // 1000äº¿ (6ä½ç²¾åº¦)

        let contract = null;
        let countdownInterval = null;
        let currentTab = 'usdt-vid';

        // çŠ¶æ€æ•°æ®
        let state = {
            connected: false,
            isCommunity: false,
            isRanked: false,
            exchangeRate: 1,
            activeInterestCount: 0,
            totalSupply: 0,
            communityCount: 0,
            totalRankedCommunities: 0,
            mintRate: 1,
            balances: { vollar: 0, usdt: 0 },
            contractBalances: { bnb: 0, usdt: 0, vid: 0 },
            timestamps: { bnb: 0, usdt: 0, vid: 0, uswap: 0 },
            rateStats: { vidQuota: 0, usdtAllocation: 0 },
            globalStats: { totalRedeemedVID: 0, allUSDTWithdrawn: 0 },
            calculated: { usdtPay: 0, vollarBurn1: 0, vollarBurn2: 0 }
        };

        // ========== å·¥å…·å‡½æ•° ==========
        function showLoading(text = 'åŠ è½½ä¸­...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        function formatNumber(num, decimals = 6, displayDecimals = 3) {
            // 1. è½¬æ¢ä¸ºå®é™…æ•°é‡
            const actual = Number(num) / Math.pow(10, decimals);
            if (actual === 0) return "0";
            
            // 2. å‘ä¸‹å–æ•´åˆ°displayDecimalsä½å°æ•°
            const factor = Math.pow(10, displayDecimals);
            const floored = Math.floor(actual * factor) / factor;
            
            // 3. è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶å»é™¤æœ«å°¾çš„0
            return floored.toString().replace(/(\.\d*?)0+$/, '$1').replace(/\.$/, '');
        }

        // æ ¼å¼åŒ–å€’è®¡æ—¶
        function formatCountdown(seconds) {
            if (seconds <= 0) return null;
            const d = Math.floor(seconds / 86400);
            const h = Math.floor((seconds % 86400) / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${d}å¤© ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // åˆ›å»ºæ˜Ÿç©º
        function createStars() {
            const container = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = star.style.height = Math.random() * 2 + 1 + 'px';
                star.style.animationDelay = Math.random() * 3 + 's';
                container.appendChild(star);
            }
        }

        // ========== é¡µé¢å¯¼èˆª ==========
        function switchPage(page) {
            const pages = { home: 'index.html', stats: 'data.html', swap: 'exchange.html', temple: 'temple.html' };
            if (pages[page] && page !== 'swap') window.location.href = pages[page];
        }
        function goBack() { window.history.back(); }

        // ========== Tabåˆ‡æ¢ ==========
        function switchTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.exchange-card').forEach(card => card.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
            document.getElementById('card-' + tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // ========== è®¡ç®—å…‘æ¢é‡‘é¢ ==========
        function calculateExchangeAmounts() {
            const { totalSupply, exchangeRate, mintRate, contractBalances } = state;

            // Tab 0: USDT â†’ VID
            const usdtPay = totalSupply < BASE_SUPPLY ? 1000 : 3000;
            const vidReceive0 = usdtPay / mintRate;
            document.getElementById('usdt-pay').textContent = usdtPay.toLocaleString();
            document.getElementById('usdt-receive').textContent = vidReceive0.toLocaleString('en-US', { maximumFractionDigits: 2 });
            state.calculated.usdtPay = usdtPay * 1e18;

            // Tab 1: Vollar â†’ BNB
            let vollarBurn1 = 100 * exchangeRate;
            const bnbBalance = contractBalances.bnb;
            if (bnbBalance < 30e18) vollarBurn1 /= 100;
            else if (bnbBalance < 100e18) vollarBurn1 /= 30;
            else if (bnbBalance < 300e18) vollarBurn1 /= 20;
            else if (bnbBalance < 1000e18) vollarBurn1 /= 10;
            const bnbReceive = vollarBurn1 * 0.001;
            document.getElementById('vollar-bnb-burn').textContent = vollarBurn1.toLocaleString('en-US', { maximumFractionDigits: 2 });
            document.getElementById('bnb-receive').textContent = bnbReceive.toLocaleString('en-US', { maximumFractionDigits: 4 });
            state.calculated.vollarBurn1 = vollarBurn1 * 1e6;

            // Tab 2: Vollar â†’ USDT
            let vollarBurn2 = 500 * exchangeRate;
            const usdtBalance = contractBalances.usdt;
            if (usdtBalance < 3000000e18) vollarBurn2 /= 100;
            else if (usdtBalance < 10000000e18) vollarBurn2 /= 30;
            else if (usdtBalance < 20000000e18) vollarBurn2 /= 20;
            else if (usdtBalance < 30000000e18) vollarBurn2 /= 10;
            const usdtReceive2 = vollarBurn2;
            document.getElementById('vollar-usdt-burn').textContent = vollarBurn2.toLocaleString('en-US', { maximumFractionDigits: 2 });
            document.getElementById('usdt-receive-2').textContent = usdtReceive2.toLocaleString('en-US', { maximumFractionDigits: 2 });
            state.calculated.vollarBurn2 = vollarBurn2 * 1e6;

            // Tab 3: Vollar â†’ VID (å›ºå®š10ä¸‡)
            const vidReceive3 = 100000 / mintRate;
            document.getElementById('vid-receive-3').textContent = vidReceive3.toLocaleString('en-US', { maximumFractionDigits: 2 });
        }

        // ========== æ£€æŸ¥å¹¶æ¸²æŸ“æ¡ä»¶ ==========
        function checkAndRenderConditions() {
            const now = Math.floor(Date.now() / 1000);
            const { isCommunity, isRanked, activeInterestCount, totalSupply, communityCount, totalRankedCommunities, timestamps, balances, contractBalances, rateStats, globalStats, calculated } = state;

            // Tab 0: USDT â†’ VID
            let html0 = '<div class="conditions-title">âš ï¸ å…‘æ¢æ¡ä»¶</div>';
            let cond0Count = 0;
            
            // éç¤¾åŒºç”¨æˆ·åªæ˜¾ç¤º"é™ç¤¾åŒºæˆå‘˜å‚ä¸"
            if (!isCommunity) {
                html0 += renderConditionItem('ğŸ‘¥', 'é™ç¤¾åŒºæˆå‘˜å‚ä¸', 'æœªæˆä¸ºç¤¾åŒº');
                cond0Count++;
            } else {
                // ç¤¾åŒºç”¨æˆ·æ˜¾ç¤ºå…¶ä»–ä¸æ»¡è¶³çš„æ¡ä»¶
                if (communityCount < 30) { html0 += renderConditionItem('ğŸ˜ï¸', 'å…¨ç½‘ç¤¾åŒºæ•°é‡', `${communityCount}/30`); cond0Count++; }
                if (activeInterestCount < 5) { html0 += renderConditionItem('ğŸ”¥', 'ç›´æ¨ç”Ÿæ¯äººæ•°', `${activeInterestCount}/5`); cond0Count++; }
                if (communityCount >= 300 && !isRanked) { html0 += renderConditionItem('ğŸ“Š', 'éœ€å…¥æ¦œå‰1000', 'æœªå…¥æ¦œ'); cond0Count++; }
                const nextUswap = timestamps.uswap + REMIN_TIME;
                if (now < nextUswap) { html0 += renderConditionItem('â°', 'è·ä¸‹æ¬¡å…‘æ¢', formatCountdown(nextUswap - now), true); cond0Count++; }
                if (totalSupply < SUPPLY_333B && Number(globalStats.totalRedeemedVID) >= Number(rateStats.vidQuota)) { html0 += renderConditionItem('ğŸ“¦', 'VIDé…é¢', 'å·²ç”¨å°½'); cond0Count++; }
                if (balances.usdt < calculated.usdtPay) { html0 += renderConditionItem('ğŸ’µ', 'USDTä½™é¢ä¸è¶³', formatNumber(balances.usdt, 18)); cond0Count++; }
                const vidNeeded0 = calculated.usdtPay / state.mintRate / 1e12;
                if (contractBalances.vid < vidNeeded0) { html0 += renderConditionItem('ğŸ¦', 'åˆçº¦VIDä¸è¶³', 'è¯·ç¨åå†è¯•'); cond0Count++; }
            }
            if (cond0Count === 0) html0 += '<div class="all-conditions-met">âœ… æ‰€æœ‰æ¡ä»¶å·²æ»¡è¶³</div>';
            document.getElementById('conditions-usdt-vid').innerHTML = html0;
            updateButton('usdt-vid', cond0Count === 0, isCommunity);

            // Tab 1: Vollar â†’ BNB
            let html1 = '<div class="conditions-title">âš ï¸ å…‘æ¢æ¡ä»¶</div>';
            let cond1Count = 0;
            
            // éç¤¾åŒºç”¨æˆ·åªæ˜¾ç¤º"é™ç¤¾åŒºæˆå‘˜å‚ä¸"
            if (!isCommunity) {
                html1 += renderConditionItem('ğŸ‘¥', 'é™ç¤¾åŒºæˆå‘˜å‚ä¸', 'æœªæˆä¸ºç¤¾åŒº');
                cond1Count++;
            } else {
                // ç¤¾åŒºç”¨æˆ·æ˜¾ç¤ºå…¶ä»–ä¸æ»¡è¶³çš„æ¡ä»¶
                if (activeInterestCount < 10) { html1 += renderConditionItem('ğŸ”¥', 'ç›´æ¨ç”Ÿæ¯äººæ•°', `${activeInterestCount}/10`); cond1Count++; }
                if (communityCount < 100) { html1 += renderConditionItem('ğŸ˜ï¸', 'å…¨ç½‘ç¤¾åŒºæ•°é‡', `${communityCount}/100`); cond1Count++; }
                if (totalSupply < BASE_SUPPLY) { html1 += renderConditionItem('ğŸ’', 'æµé€šé‡è¦æ±‚', `${formatNumber(totalSupply, 6)}/2100ä¸‡`); cond1Count++; }
                if (communityCount >= 200 && !isRanked) { html1 += renderConditionItem('ğŸ“Š', 'éœ€å…¥æ¦œå‰100', 'æœªå…¥æ¦œ'); cond1Count++; }
                const nextBnb = timestamps.bnb + REMAX_TIME;
                if (now < nextBnb) { html1 += renderConditionItem('â°', 'è·ä¸‹æ¬¡å…‘æ¢', formatCountdown(nextBnb - now), true); cond1Count++; }
                if (balances.vollar < calculated.vollarBurn1) { html1 += renderConditionItem('ğŸª™', 'Vollarä½™é¢ä¸è¶³', formatNumber(balances.vollar, 6)); cond1Count++; }
                const bnbNeeded = calculated.vollarBurn1 * 1e3;
                if (contractBalances.bnb < bnbNeeded) { html1 += renderConditionItem('ğŸ¦', 'åˆçº¦BNBä¸è¶³', 'è¯·ç¨åå†è¯•'); cond1Count++; }
            }
            if (cond1Count === 0) html1 += '<div class="all-conditions-met">âœ… æ‰€æœ‰æ¡ä»¶å·²æ»¡è¶³</div>';
            document.getElementById('conditions-vollar-bnb').innerHTML = html1;
            updateButton('vollar-bnb', cond1Count === 0, isCommunity);

            // Tab 2: Vollar â†’ USDT
            let html2 = '<div class="conditions-title">âš ï¸ å…‘æ¢æ¡ä»¶</div>';
            let cond2Count = 0;
            
            // éç¤¾åŒºç”¨æˆ·åªæ˜¾ç¤º"é™ç¤¾åŒºæˆå‘˜å‚ä¸"
            if (!isCommunity) {
                html2 += renderConditionItem('ğŸ‘¥', 'é™ç¤¾åŒºæˆå‘˜å‚ä¸', 'æœªæˆä¸ºç¤¾åŒº');
                cond2Count++;
            } else {
                // ç¤¾åŒºç”¨æˆ·æ˜¾ç¤ºå…¶ä»–ä¸æ»¡è¶³çš„æ¡ä»¶
                if (activeInterestCount < 10) { html2 += renderConditionItem('ğŸ”¥', 'ç›´æ¨ç”Ÿæ¯äººæ•°', `${activeInterestCount}/10`); cond2Count++; }
                if (totalSupply < BASE_BILLION) { html2 += renderConditionItem('ğŸ’', 'æµé€šé‡è¦æ±‚', `${formatNumber(totalSupply, 6)}/1äº¿`); cond2Count++; }
                if (communityCount >= 500 && !isRanked) { html2 += renderConditionItem('ğŸ“Š', 'éœ€å…¥æ¦œå‰100', 'æœªå…¥æ¦œ'); cond2Count++; }
                if (totalSupply < SUPPLY_333B && Number(globalStats.allUSDTWithdrawn) >= Number(rateStats.usdtAllocation)) { html2 += renderConditionItem('ğŸ“¦', 'USDTé…é¢', 'å·²ç”¨å°½'); cond2Count++; }
                const nextUsdt = timestamps.usdt + REMAX_TIME;
                if (now < nextUsdt) { html2 += renderConditionItem('â°', 'è·ä¸‹æ¬¡å…‘æ¢', formatCountdown(nextUsdt - now), true); cond2Count++; }
                if (balances.vollar < calculated.vollarBurn2) { html2 += renderConditionItem('ğŸª™', 'Vollarä½™é¢ä¸è¶³', formatNumber(balances.vollar, 6)); cond2Count++; }
                const usdtNeeded = calculated.vollarBurn2 * 1e6;
                if (contractBalances.usdt < usdtNeeded) { html2 += renderConditionItem('ğŸ¦', 'åˆçº¦USDTä¸è¶³', 'è¯·ç¨åå†è¯•'); cond2Count++; }
            }
            if (cond2Count === 0) html2 += '<div class="all-conditions-met">âœ… æ‰€æœ‰æ¡ä»¶å·²æ»¡è¶³</div>';
            document.getElementById('conditions-vollar-usdt').innerHTML = html2;
            updateButton('vollar-usdt', cond2Count === 0, isCommunity);

            // Tab 3: Vollar â†’ VID
            let html3 = '<div class="conditions-title">âš ï¸ å…‘æ¢æ¡ä»¶</div>';
            let cond3Count = 0;
            if (totalSupply < SUPPLY_1000B) { html3 += renderConditionItem('ğŸ’', 'æµé€šé‡è¦æ±‚', `${formatNumber(totalSupply, 6)}/1000äº¿`); cond3Count++; }
            if (!isRanked) { html3 += renderConditionItem('ğŸ“Š', 'éœ€å…¥æ¦œå‰100', 'æœªå…¥æ¦œ'); cond3Count++; }
            const nextVid = timestamps.vid + REMAX_TIME;
            if (now < nextVid) { html3 += renderConditionItem('â°', 'è·ä¸‹æ¬¡å…‘æ¢', formatCountdown(nextVid - now), true); cond3Count++; }
            if (balances.vollar < 100000e6) { html3 += renderConditionItem('ğŸª™', 'Vollarä½™é¢ä¸è¶³', formatNumber(balances.vollar, 6)); cond3Count++; }
            const vidNeeded3 = 100000e6 / state.mintRate;
            if (contractBalances.vid < vidNeeded3) { html3 += renderConditionItem('ğŸ¦', 'åˆçº¦VIDä¸è¶³', 'è¯·ç¨åå†è¯•'); cond3Count++; }
            if (cond3Count === 0) html3 += '<div class="all-conditions-met">âœ… æ‰€æœ‰æ¡ä»¶å·²æ»¡è¶³</div>';
            document.getElementById('conditions-vollar-vid').innerHTML = html3;
            updateButton('vollar-vid', cond3Count === 0, true); // Vollarâ†’VID ä¸éœ€è¦ç¤¾åŒºèº«ä»½æ£€æŸ¥
        }

        function renderConditionItem(icon, label, status, isCountdown = false) {
            return `<div class="condition-item">
                <div class="condition-label"><span>${icon}</span><span>${label}</span></div>
                <div class="condition-status ${isCountdown ? 'status-countdown' : 'status-fail'}">${status}</div>
            </div>`;
        }

        function updateButton(tabId, conditionsMet, checkCommunity = true) {
            const btn = document.getElementById(`btn-${tabId}`);
            const btnText = document.getElementById(`btn-text-${tabId}`);
            
            if (!state.connected) {
                btn.className = 'exchange-btn btn-disabled';
                btnText.textContent = 'è¯·å…ˆè¿æ¥é’±åŒ…';
            } else if (checkCommunity && !state.isCommunity) {
                btn.className = 'exchange-btn btn-disabled';
                btnText.textContent = 'é™ç¤¾åŒºæˆå‘˜å‚ä¸';
            } else if (!conditionsMet) {
                btn.className = 'exchange-btn btn-disabled';
                btnText.textContent = 'æ¡ä»¶æœªæ»¡è¶³';
            } else if (tabId === 'usdt-vid') {
                // éœ€è¦æ£€æŸ¥æˆæƒ
                btn.className = 'exchange-btn btn-warning';
                btnText.textContent = 'æ£€æŸ¥æˆæƒä¸­...';
                checkUsdtAllowance();
            } else {
                btn.className = 'exchange-btn btn-enabled';
                btnText.textContent = 'ç«‹å³å…‘æ¢';
            }
        }

        // ========== æ£€æŸ¥USDTæˆæƒ ==========
        async function checkUsdtAllowance() {
            try {
                const allowance = await web3Manager.getAllowance(CONFIG.CONTRACTS.USDT, CONFIG.CONTRACTS.TokenBank);
                const needed = state.calculated.usdtPay;
                const btn = document.getElementById('btn-usdt-vid');
                const btnText = document.getElementById('btn-text-usdt-vid');
                
                if (BigInt(allowance) >= BigInt(Math.floor(needed).toString())) {
                    btn.className = 'exchange-btn btn-enabled';
                    btnText.textContent = 'ç«‹å³å…‘æ¢';
                } else {
                    btn.className = 'exchange-btn btn-warning';
                    btnText.textContent = 'æˆæƒ USDT';
                }
            } catch (e) {
                console.error('æ£€æŸ¥æˆæƒå¤±è´¥:', e);
            }
        }

        // ========== æ›´æ–°é…é¢è¿›åº¦ ==========
        function updateQuotaProgress() {
            const { totalSupply, rateStats, globalStats } = state;

            // VID é…é¢
            if (totalSupply >= SUPPLY_333B) {
                document.getElementById('quota-usdt-vid').innerHTML = '<div class="quota-unlocked">âœ… VID é…é¢é™åˆ¶å·²è§£é™¤</div>';
            } else {
                const usedVid = Number(globalStats.totalRedeemedVID) / 1e6;
                const totalVid = Number(rateStats.vidQuota) / 1e6;
                const percentVid = totalVid > 0 ? (usedVid / totalVid * 100) : 0;
                document.getElementById('quota-bar-vid').style.width = Math.min(percentVid, 100) + '%';
                document.getElementById('quota-bar-vid').className = `progress-fill ${percentVid > 80 ? 'progress-red' : percentVid > 50 ? 'progress-yellow' : 'progress-green'}`;
                document.getElementById('quota-used-vid').textContent = usedVid.toLocaleString('en-US', { maximumFractionDigits: 2 });
                document.getElementById('quota-total-vid').textContent = totalVid.toLocaleString('en-US', { maximumFractionDigits: 2 });
                document.getElementById('quota-percent-vid').textContent = percentVid.toFixed(2) + '%';
            }

            // USDT é…é¢
            if (totalSupply >= SUPPLY_333B) {
                document.getElementById('quota-vollar-usdt').innerHTML = '<div class="quota-unlocked">âœ… USDT é…é¢é™åˆ¶å·²è§£é™¤</div>';
            } else {
                const usedUsdt = Number(globalStats.allUSDTWithdrawn) / 1e18;
                const totalUsdt = Number(rateStats.usdtAllocation) / 1e18;
                const percentUsdt = totalUsdt > 0 ? (usedUsdt / totalUsdt * 100) : 0;
                document.getElementById('quota-bar-usdt').style.width = Math.min(percentUsdt, 100) + '%';
                document.getElementById('quota-bar-usdt').className = `progress-fill ${percentUsdt > 80 ? 'progress-red' : percentUsdt > 50 ? 'progress-yellow' : 'progress-green'}`;
                document.getElementById('quota-used-usdt').textContent = usedUsdt.toLocaleString('en-US', { maximumFractionDigits: 2 });
                document.getElementById('quota-total-usdt').textContent = totalUsdt.toLocaleString('en-US', { maximumFractionDigits: 2 });
                document.getElementById('quota-percent-usdt').textContent = percentUsdt.toFixed(2) + '%';
            }
        }

        // ========== æ›´æ–°ä½™é¢æ˜¾ç¤º ==========
        function updateBalanceDisplay() {
            document.getElementById('usdt-balance').textContent = formatNumber(state.balances.usdt, 18);
            document.getElementById('vollar-bnb-balance').textContent = formatNumber(state.balances.vollar, 6);
            document.getElementById('vollar-usdt-balance').textContent = formatNumber(state.balances.vollar, 6);
            document.getElementById('vollar-vid-balance').textContent = formatNumber(state.balances.vollar, 6);
            
            document.getElementById('contract-vid-0').textContent = formatNumber(state.contractBalances.vid, 6);
            document.getElementById('contract-bnb').textContent = formatNumber(state.contractBalances.bnb, 18);
            document.getElementById('contract-usdt').textContent = formatNumber(state.contractBalances.usdt, 18);
            document.getElementById('contract-vid-3').textContent = formatNumber(state.contractBalances.vid, 6);
        }

        // ========== åŠ è½½æ•°æ® ==========
        async function loadData() {
            try {
                if (typeof web3Manager === 'undefined') {
                    setTimeout(loadData, 500);
                    return;
                }

                if (!web3Manager.web3) {
                    await web3Manager.init();
                }

                // æ£€æµ‹é’±åŒ…è¿æ¥çŠ¶æ€
                if (window.ethereum && window.ethereum.selectedAddress) {
                    web3Manager.account = window.ethereum.selectedAddress;
                    web3Manager.isConnected = true;
                    state.connected = true;
                }

                contract = web3Manager.getContract(TOKENBANK_ABI, CONFIG.CONTRACTS.TokenBank);
                if (!contract) {
                    console.error('æ— æ³•è·å–åˆçº¦å®ä¾‹');
                    return;
                }

                // åŠ è½½å…¨å±€æ•°æ®
                const [globalStats, rateStats, globalRanking, totalSupply] = await Promise.all([
                    contract.methods.getGlobalStats().call(),
                    contract.methods.getRateStats().call(),
                    contract.methods.getGlobalRankingInfo().call(),
                    contract.methods.totalSupply().call()
                ]);

                state.totalSupply = Number(totalSupply);
                state.mintRate = Number(rateStats.mintRate) || 1;
                state.communityCount = Number(globalRanking.totalGlobalCommunities);
                state.totalRankedCommunities = Number(globalRanking.totalRankedCommunities);
                state.rateStats = { vidQuota: rateStats.vidQuota, usdtAllocation: rateStats.usdtAllocation };
                state.globalStats = { totalRedeemedVID: globalStats.totalRedeemedVID, allUSDTWithdrawn: globalStats.allUSDTWithdrawn };

                // åŠ è½½åˆçº¦ä½™é¢
                const vidContract = web3Manager.getContract(ERC20_ABI, CONFIG.CONTRACTS.VID);
                const usdtContract = web3Manager.getContract(ERC20_ABI, CONFIG.CONTRACTS.USDT);
                const [contractBnb, contractVid, contractUsdt] = await Promise.all([
                    web3Manager.web3.eth.getBalance(CONFIG.CONTRACTS.TokenBank),
                    vidContract.methods.balanceOf(CONFIG.CONTRACTS.TokenBank).call(),
                    usdtContract.methods.balanceOf(CONFIG.CONTRACTS.TokenBank).call()
                ]);
                state.contractBalances = { bnb: Number(contractBnb), usdt: Number(contractUsdt), vid: Number(contractVid) };

                // åŠ è½½ç”¨æˆ·æ•°æ®
                if (state.connected) {
                    const [isCommunity, userRanking, refStatus, timestamps, vollarBalance, usdtBalance] = await Promise.all([
                        contract.methods.amICommunityMember().call({ from: web3Manager.account }),
                        contract.methods.getUserRankingInfo().call({ from: web3Manager.account }),
                        contract.methods.getUserRefInterestStatus().call({ from: web3Manager.account }),
                        contract.methods.getUserTimestamps().call({ from: web3Manager.account }),
                        contract.methods.balanceOf(web3Manager.account).call(),
                        usdtContract.methods.balanceOf(web3Manager.account).call()
                    ]);

                    state.isCommunity = isCommunity;
                    state.isRanked = userRanking.isRanked;
                    state.exchangeRate = Number(userRanking.exchangeRate) || 1;
                    state.activeInterestCount = Number(refStatus.activeInterestCount);
                    state.timestamps = {
                        bnb: Number(timestamps.lastBnbTime),
                        usdt: Number(timestamps.lastUsdtTime),
                        vid: Number(timestamps.lastVidTime),
                        uswap: Number(timestamps.lastUSwapVTime)
                    };
                    state.balances = { vollar: Number(vollarBalance), usdt: Number(usdtBalance) };
                }

                // è®¡ç®—å’Œæ¸²æŸ“
                calculateExchangeAmounts();
                checkAndRenderConditions();
                updateQuotaProgress();
                updateBalanceDisplay();

                // å¯åŠ¨å€’è®¡æ—¶
                if (countdownInterval) clearInterval(countdownInterval);
                countdownInterval = setInterval(() => {
                    checkAndRenderConditions();
                }, 1000);

                console.log('æ•°æ®åŠ è½½å®Œæˆ', state);

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // ========== æ‰§è¡Œå…‘æ¢ ==========
        async function handleExchange(tabId) {
            if (!state.connected) {
                showToast('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }

            const btnText = document.getElementById(`btn-text-${tabId}`).textContent;
            if (btnText === 'æ¡ä»¶æœªæ»¡è¶³' || btnText === 'é™ç¤¾åŒºæˆå‘˜å‚ä¸' || btnText === 'è¯·å…ˆè¿æ¥é’±åŒ…') {
                showToast(btnText, 'error');
                return;
            }

            try {
                showLoading('å¤„ç†ä¸­...');

                if (tabId === 'usdt-vid') {
                    if (btnText === 'æˆæƒ USDT') {
                        await web3Manager.approve(CONFIG.CONTRACTS.USDT, CONFIG.CONTRACTS.TokenBank, state.calculated.usdtPay.toString());
                        hideLoading();
                        showToast('æˆæƒæˆåŠŸï¼', 'success');
                        await checkUsdtAllowance();
                        return;
                    }
                    await web3Manager.sendTransaction(contract, 'communityUSDTForVID', []);
                } else if (tabId === 'vollar-bnb') {
                    await web3Manager.sendTransaction(contract, 'communityVollarForBNB', []);
                } else if (tabId === 'vollar-usdt') {
                    await web3Manager.sendTransaction(contract, 'communityVollarForUSDT', []);
                } else if (tabId === 'vollar-vid') {
                    await web3Manager.sendTransaction(contract, 'communityVollarForVID', []);
                }

                hideLoading();
                showToast('å…‘æ¢æˆåŠŸï¼', 'success');
                setTimeout(() => loadData(), 2000);

            } catch (error) {
                hideLoading();
                console.error('å…‘æ¢å¤±è´¥:', error);
                if (error.code === 4001) {
                    showToast('ç”¨æˆ·å–æ¶ˆäº¤æ˜“', 'error');
                } else {
                    showToast('å…‘æ¢å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            }
        }

        // ========== åˆ·æ–° ==========
        function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('spinning');
            setTimeout(() => {
                btn.classList.remove('spinning');
                loadData();
            }, 500);
        }

        // ========== åˆå§‹åŒ– ==========
        createStars();
        setTimeout(loadData, 100);
    </script>
</body>
</html>
