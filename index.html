<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
	<link rel="icon" href="./favicon.ico" type="image/x-icon">
	<link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
	<title>ä¹èŠ±è”ç›Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>

    <style>
		
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #0a0520;
            color: #fff;
            overflow-x: hidden;
        }

        /* ğŸ¨ ç»å…¸ç´«è‰²æ¸å˜èƒŒæ™¯ */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0a0520 0%, #1a0b3d 50%, #2d1055 100%);
            z-index: -2;
        }

        .bg-stars {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(168,85,247,0.4), transparent),
                radial-gradient(1px 1px at 50% 50%, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 80% 10%, rgba(217,70,239,0.3), transparent),
                radial-gradient(2px 2px at 90% 60%, rgba(139,92,246,0.2), transparent);
            background-size: 200% 200%;
            animation: twinkle 8s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: rgba(26, 11, 61, 0.6);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(168, 85, 247, 0.2);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-img {
            width: 40px;
            height: 40px;
            filter: drop-shadow(0 2px 8px rgba(251, 146, 60, 0.5));
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, #fb923c 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .lang-btn {
            padding: 8px 12px;
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 10px;
            color: #a855f7;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .wallet-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(217, 70, 239, 0.2) 100%);
            border: 1px solid rgba(168, 85, 247, 0.5);
            border-radius: 12px;
            color: #a855f7;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            padding: 20px;
            padding-bottom: 100px;
        }

        /* å¤´éƒ¨èµ„äº§å¡ç‰‡ */
        .hero-card {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(217, 70, 239, 0.15) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 
                0 10px 40px rgba(168, 85, 247, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .hero-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(168, 85, 247, 0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .balance-section {
            margin-bottom: 20px;
        }

        .balance-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .balance-amount {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, rgba(255, 255, 255, 0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
            line-height: 1;
            margin-bottom: 5px;
        }

        .vollar-integer {
            font-size: 36px;
            font-weight: 800;
        }

        .vollar-decimal {
            font-size: 26px;
            font-weight: 500;
        }

        /* ç”Ÿæ¯åŒºåŸŸ */
        .interest-section {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.15) 100%);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .interest-info {
            flex: 1;
            min-width: 0;
        }

        .interest-label {
            font-size: 13px;
            color: rgba(251, 191, 36, 0.8);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .interest-value {
            font-size: 22px;
            font-weight: 700;
            color: #fbbf24;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
            word-break: break-all;
            transition: all 0.3s ease-out;
        }

        .interest-countdown {
            font-size: 12px;
            color: rgba(251, 191, 36, 0.6);
            margin-top: 4px;
        }

        .interest-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border: none;
            border-radius: 12px;
            color: #1a0b3d;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .interest-btn:active {
            transform: scale(0.95);
        }

        .interest-btn.activate {
            background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%);
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
            color: #fff;
        }

        .interest-section.inactive .interest-value {
            color: rgba(255, 255, 255, 0.4);
            text-shadow: none;
        }

        /* å…±æŒ¯é“¸é€ å¡ç‰‡ */
        .section-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* æ±‡ç‡æ˜¾ç¤ºï¼ˆå³ä¸Šè§’ï¼‰ */
        .exchange-rate {
            font-size: 14px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.8);
        }

        .exchange-rate .rate-number {
            font-weight: 700;
            color: #a855f7;
        }

        /* Tab åˆ‡æ¢ */
        .tab-group {
            display: flex;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            padding: 4px;
            margin-bottom: 18px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.3) 0%, rgba(217, 70, 239, 0.3) 100%);
            color: #fff;
            border: 1px solid rgba(168, 85, 247, 0.5);
            box-shadow: 0 2px 10px rgba(168, 85, 247, 0.3);
        }

        /* è¾“å…¥æ¡† */
        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .balance-integer {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .balance-decimal {
            font-size: 14px;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.9);
        }

        .input-wrapper {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            flex-wrap: nowrap;
            overflow: hidden;
            position: relative;
        }

        .input-wrapper:focus-within {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }

        .input-wrapper.error {
            border-color: rgba(239, 68, 68, 0.5);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .input-wrapper input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 20px;
            font-weight: 600;
            outline: none;
            min-width: 0;
            width: 0;
            flex: 1 1 auto;
            -webkit-text-size-adjust: 100%;
        }

        .input-wrapper input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .max-btn {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(217, 70, 239, 0.2) 100%);
            border: 1px solid rgba(168, 85, 247, 0.4);
            color: #a855f7;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: 50px;
            text-align: center;
            line-height: 1.2;
        }

        .max-btn:active {
            transform: scale(0.95);
        }

        /* å°†è·å¾— Vollar æ˜¾ç¤º */
        .will-receive-row {
            padding: 16px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .will-receive-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            flex-shrink: 0;
        }

        .will-receive-value {
            font-size: 18px;
            font-weight: 800;
            color: #fbbf24;
            line-height: 1.6;
            word-wrap: break-word;
            flex: 1;
        }

        /* ä¸»æŒ‰é’® */
        .primary-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%);
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .primary-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .primary-btn:active::before {
            left: 100%;
        }

        .primary-btn:active {
            transform: scale(0.98);
        }

        .primary-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* åº•éƒ¨å¯¼èˆª */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 12px 0 20px;
            background: rgba(26, 11, 61, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(168, 85, 247, 0.2);
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
			transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px 16px;
            border-radius: 12px;
        }

        .nav-item.active {
            background: rgba(168, 85, 247, 0.15);
        }

        .nav-icon {
            font-size: 24px;
            transition: all 0.3s;
        }

        .nav-item.active .nav-icon {
            color: #a855f7;
            transform: scale(1.1);
        }

        .nav-item:not(.active) .nav-icon {
            color: rgba(255, 255, 255, 0.6);
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-item.active .nav-label {
            color: #a855f7;
        }

        .nav-item:not(.active) .nav-label {
            color: rgba(255, 255, 255, 0.6);
        }

        /* âœ… ä¿®å¤ï¼šç§»åŠ¨ç«¯é”®ç›˜å¤„ç† */
        @media (hover: none) and (pointer: coarse) {
            body.keyboard-open .bottom-nav {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                transform: translateY(100%) !important;
                pointer-events: none !important;
            }
            
            body.keyboard-open .container {
                padding-bottom: 30px !important;
            }
        }

        /* âœ… æ–°å¢ï¼šiOSä¸“ç”¨å¼ºåˆ¶éšè— */
        @supports (-webkit-touch-callout: none) {
            body.keyboard-open .bottom-nav,
            body.ios-keyboard-open .bottom-nav {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                transform: translateY(150%) !important;
                position: fixed !important;
                bottom: -100px !important;
                pointer-events: none !important;
                z-index: -1 !important;
            }
        }

        /* âœ… æ–°å¢ï¼šé€šç”¨è¾“å…¥çŠ¶æ€ç±» */
        .input-focused .bottom-nav {
            display: none !important;
            visibility: hidden !important;
            transform: translateY(100%) !important;
        }

        /* å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, rgba(26, 11, 61, 0.95) 0%, rgba(45, 16, 85, 0.95) 100%);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 24px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .default-addr-btn-header {
            padding: 6px 12px;
            background: rgba(168, 85, 247, 0.2);
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 8px;
            color: #a855f7;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .default-addr-btn-header:active {
            transform: scale(0.95);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-input-group {
            position: relative;
            margin-bottom: 16px;
        }

        .modal-input-group textarea {
            width: 100%;
            padding: 14px 80px 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            outline: none;
            transition: all 0.3s;
            resize: none;
            overflow-y: auto;
            max-height: 56px;
            line-height: 1.4;
            word-break: break-all;
        }

        .modal-input-group textarea:focus {
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }

        .modal-input-group textarea.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .input-action-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            padding: 6px 12px;
            background: rgba(168, 85, 247, 0.2);
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 8px;
            color: #a855f7;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .input-action-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .error-msg {
            color: #ef4444;
            font-size: 12px;
            margin-top: 8px;
            display: none;
        }

        .error-msg.show {
            display: block;
        }

        .fee-info {
            padding: 12px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 10px;
            font-size: 13px;
            color: rgba(251, 191, 36, 0.9);
            margin-bottom: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }

        .modal-btn.confirm {
            background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4);
        }

        .modal-btn:active {
            transform: scale(0.95);
        }

        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* å…¨å±€åŠ è½½å±‚ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay .loading-content {
            background: #1a0b3d;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(168,85,247,0.3);
        }

        .loading-overlay .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #a855f7;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                padding-bottom: 120px;
            }
            
            .input-wrapper {
                padding: 12px 14px;
            }
            
            .input-wrapper input {
                font-size: 20px;
            }
            
            .max-btn {
                padding: 8px 14px;
                font-size: 12px;
                min-width: 45px;
            }
            
            .will-receive-row {
                padding: 12px 0;
                margin-bottom: 12px;
            }
            
            .primary-btn {
                margin-top: 8px;
            }
        }

        @media (max-width: 375px) {
            .balance-amount {
                font-size: 36px;
            }
            .interest-value {
                font-size: 16px;
            }
            .interest-btn {
                padding: 10px 18px;
                font-size: 13px;
            }
            .will-receive-value {
                font-size: 20px;
            }
            
            .input-wrapper {
                padding: 10px 12px;
            }
            
            .max-btn {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 40px;
            }
            
            .input-wrapper input {
                font-size: 18px;
            }
        }
		
		/* iOSä¸“å±ä¿®å¤ - æ”¾åœ¨CSSæ–‡ä»¶æœ€å */
		@supports (-webkit-touch-callout: none) {
			.section-card {
				backdrop-filter: none !important;
				-webkit-backdrop-filter: none !important;
				background: rgba(26, 11, 61, 0.8) !important;
				border: 1px solid rgba(168, 85, 247, 0.4) !important;
			}
			
			/* åŒæ—¶ä¿®å¤è¾“å…¥æ¡†çš„æ˜¾ç¤ºé—®é¢˜ */
			.input-wrapper {
				background: rgba(255, 255, 255, 0.1) !important;
			}
		}

    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    <div class="bg-stars"></div>

    <div class="loading-overlay" id="globalLoading">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">åŠ è½½ä¸­...</p>
        </div>
    </div>

    <div class="top-bar">
        <div class="logo">
            <img src="./img/200.png" alt="ä¹èŠ±è”ç›Ÿ" class="logo-img">
            <div class="logo-text">ä¹èŠ±è”ç›Ÿ</div>
        </div>
        <div class="top-right">
            <button class="lang-btn" onclick="toggleLanguage()">
                ğŸŒ <span id="currentLang">ä¸­æ–‡</span>
            </button>
            <button class="wallet-btn" onclick="connectWallet()">
                <span id="walletBtnText">è¿æ¥é’±åŒ…</span>
            </button>
        </div>
    </div>

    <div class="container">
        <div class="hero-card">
            <div class="hero-content">
                <div class="balance-section">
                    <div class="balance-label">
                        <span>ğŸ’</span>
                        æˆ‘çš„ Vollar
                    </div>
                    <div class="balance-amount" id="vollarBalance">0</div>
                </div>

                <div class="interest-section inactive" id="interestSection">
                    <div class="interest-info">
                        <div class="interest-label">âš¡ å¾…é¢†åˆ©æ¯</div>
                        <div class="interest-value" id="interestValue">-- æœªå¼€å¯ --</div>
                        <div class="interest-countdown" id="interestCountdown" style="display: none;">
                            â±ï¸ è·å°é¡¶: 29å¤© 23æ—¶ 59åˆ†
                        </div>
                    </div>
                    <button class="interest-btn activate" id="interestBtn" onclick="handleInterestAction()">
                        å¼€å¯ç”Ÿæ¯
                    </button>
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span>ğŸ”¥</span>
                    å…±æŒ¯é“¸é€ 
                </div>
                <div class="exchange-rate" id="exchangeRate">
                    é“¸é€ æ±‡ç‡ <span class="rate-number">1:11,111</span>
                </div>
            </div>

            <div class="tab-group">
                <button class="tab-btn active" onclick="switchTab('VID')">VID</button>
                <button class="tab-btn" onclick="switchTab('USDT')">USDT</button>
            </div>

            <div class="input-group">
                <div class="input-label" id="balanceLabel">
                    æˆ‘çš„ä½™é¢: <span id="availableBalance">0 VID</span>
                </div>
                <div class="input-wrapper" id="inputWrapper">
                    <input 
                        type="text" 
                        inputmode="decimal"
                        pattern="[0-9.]*"
                        placeholder="è¯·è¾“å…¥å…±æŒ¯æ•°é‡" 
                        id="resonateInput" 
                        oninput="calculateResonate()"
                    >
                    <button class="max-btn" onclick="setMaxAmount()">MAX</button>
                </div>
            </div>

            <div class="will-receive-row">
                <div class="will-receive-label">è·å¾— Vollar:</div>
                <div class="will-receive-value" id="willReceiveValue">0</div>
            </div>

            <button class="primary-btn" id="resonateBtn" onclick="handleResonate()" disabled>
                è¯·è¾“å…¥é‡‘é¢
            </button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('home')" data-page="home">
            <div class="nav-icon">ğŸ </div>
            <div class="nav-label">é¦–é¡µ</div>
        </div>
        <div class="nav-item" onclick="switchPage('stats')" data-page="stats">
            <div class="nav-icon">ğŸ“Š</div>
            <div class="nav-label">æ•°æ®</div>
        </div>
        <div class="nav-item" onclick="switchPage('swap')" data-page="swap">
            <div class="nav-icon">ğŸ’°</div>
            <div class="nav-label">å…‘æ¢</div>
        </div>
        <div class="nav-item" onclick="switchPage('temple')" data-page="temple">
            <div class="nav-icon">ğŸ›ï¸</div>
            <div class="nav-label">åœ£æ®¿</div>
        </div>
    </div>

    <div class="modal-overlay" id="bindModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-header-left">
                    <div>âš ï¸</div>
                    <div class="modal-title">ç»‘å®šæ¨èå…³ç³»</div>
                </div>
                <button class="default-addr-btn-header" onclick="useDefaultAddress()">
                    é»˜è®¤åœ°å€
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-input-group">
                    <textarea 
                        placeholder="è¯·è¾“å…¥æ¨èäººåœ°å€ (0x...)" 
                        id="referrerInput"
                        rows="1"
                    ></textarea>
                    <button class="input-action-btn" id="inputActionBtn" onclick="handleInputAction()">
                        ç²˜è´´
                    </button>
                </div>
                <div class="error-msg" id="errorMsg">
                    âŒ æ¨èäººåœ°å€æ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡è¯•
                </div>
                <div class="fee-info">
                    ğŸ’¡ éœ€æ”¯ä»˜ Gas è´¹: <strong id="bindFee">0.001 BNB</strong>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeBindModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" id="confirmBindBtn" onclick="confirmBind()">
                    ç¡®è®¤ç»‘å®š
                </button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/web3-manager.js"></script>
    <script src="js/digit-roller.js"></script>
	<script src="js/bug-fixes.js"></script>
	
    <script>
    // âœ… è®¾å¤‡æ£€æµ‹
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
        || ('ontouchstart' in window) 
        || (navigator.maxTouchPoints > 0);

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    const IS_DEV = false;

    function devLog(message, data) {
        if (IS_DEV) {
            if (data !== undefined) {
                console.log(`[DEV] ${message}`, data);
            } else {
                console.log(`[DEV] ${message}`);
            }
        }
    }

    let balances = {
        bnb: '0.00',
        vid: '0.00',
        usdt: '0.00',
        vollar: '0.00'
    };

    let userState = {
        connected: false,
        address: '',
        hasReferrer: false,
        isCommunity: false,
        totalSupply: 15000000e6,
        currentToken: 'VID',
        currentMintRate: 11111,
        interestActivated: false,
        vidBalance: 0,
        usdtBalance: 0,
		communityCount: 0,
    };

	// ==================== æ›¿æ¢åŸæœ‰çš„æ ¼å¼åŒ–å‡½æ•° ====================

	function formatVollarBalance(num) {
	  if (!num || isNaN(num) || num <= 0) {
		return `<span class="vollar-integer">0</span><span class="vollar-decimal">.00</span>`;
	  }
	  
	  // ä½¿ç”¨æ–°çš„å‘ä¸‹èˆå…¥å‡½æ•°
	  const truncated = getTruncatedBalance(num, 2);
	  const parts = truncated.toFixed(2).split('.');
	  const integer = parseInt(parts[0] || '0').toLocaleString();
	  const decimal = parts[1] || '00';
	  
	  return `<span class="vollar-integer">${integer}</span><span class="vollar-decimal">.${decimal}</span>`;
	}

	function formatBalance(num, decimals = 2) {
	  if (!num || isNaN(num) || num <= 0) {
		return `<span class="balance-integer">0</span><span class="balance-decimal">.${'0'.repeat(decimals)}</span>`;
	  }
	  
	  // ä½¿ç”¨æ–°çš„å‘ä¸‹èˆå…¥å‡½æ•°
	  const truncated = getTruncatedBalance(num, decimals);
	  const parts = truncated.toFixed(decimals).split('.');
	  const integer = parseInt(parts[0] || '0').toLocaleString();
	  const decimal = parts[1] || '0'.repeat(decimals);
	  
	  return `<span class="balance-integer">${integer}</span><span class="balance-decimal">.${decimal}</span>`;
	}

	function getTruncatedBalance(num, decimals = 2) {
	  if (!num || isNaN(num) || num <= 0) {
		return 0;
	  }
	  
	  const factor = Math.pow(10, decimals);
	  return Math.floor(parseFloat(num) * factor) / factor;
	}

	function formatNumber(num, decimals = 0) {
	  if (!num || isNaN(num)) {
		num = 0;
	  }
	  
	  if (decimals > 0) {
		// ä½¿ç”¨å‘ä¸‹èˆå…¥
		const factor = Math.pow(10, decimals);
		const truncated = Math.floor(parseFloat(num) * factor) / factor;
		return truncated.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
	  }
	  
	  // å¯¹äºæ•´æ•°ï¼Œç›´æ¥å‘ä¸‹å–æ•´
	  return Math.floor(parseFloat(num)).toLocaleString();
	}

    function showLoading(text = 'åŠ è½½ä¸­...') {
        const loading = document.getElementById('globalLoading');
        const textEl = document.getElementById('loadingText');
        textEl.textContent = text;
        loading.style.display = 'flex';
    }

    function hideLoading() {
        const loading = document.getElementById('globalLoading');
        loading.style.display = 'none';
    }
	
	function formatWalletAddress(address) {
	    if (!address || typeof address !== 'string') {
	        return 'è¿æ¥é’±åŒ…';
	    }
	    const prefix = address.substring(0, 2);
	    const suffix = address.substring(address.length - 4);
	    return `${prefix}...${suffix}`;
	}

	function handleAccountChanged(account) {
	    devLog('è´¦æˆ·å˜åŒ–:', account);
	    
	    if (account) {
	        userState.address = account;
	        userState.connected = true;
	        document.getElementById('walletBtnText').textContent = formatWalletAddress(account);
	        updateUI();
	    } else {
	        disconnectWallet();
	    }
	}
	
    async function initPage() {
        devLog('å¼€å§‹åˆå§‹åŒ–é¡µé¢');
        
        initUI();
		initKeyboardHandler();
		// âœ… æ·»åŠ BugFixesï¼ˆåŒ…å«æ‰€æœ‰ä¿®å¤ï¼‰
		if (typeof BugFixes !== 'undefined') {
			window.bugFixes = new BugFixes().init();
		}
        
        if (typeof window.ethereum === 'undefined') {
            alert('è¯·å®‰è£…MetaMaské’±åŒ…');
            return;
        }
        
        try {
            showLoading('åˆå§‹åŒ–Web3...');
            
            const success = await web3Manager.init();
            if (!success) {
                devLog('Web3åˆå§‹åŒ–å¤±è´¥');
                hideLoading();
                return;
            }
            
            web3Manager.onAccountChanged = handleAccountChanged;
            
            if (window.ethereum.selectedAddress) {
                devLog('æ£€æµ‹åˆ°å·²è¿æ¥é’±åŒ…');
                web3Manager.account = window.ethereum.selectedAddress;
                web3Manager.isConnected = true;
                userState.address = web3Manager.account;
                userState.connected = true;
                
                document.getElementById('walletBtnText').textContent = formatWalletAddress(web3Manager.account);
                
                await updateUI();
            }
            
            hideLoading();
            devLog('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            
        } catch (error) {
            console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            hideLoading();
            alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
        }
    }

	async function connectWallet() {
		const btn = document.querySelector('.wallet-btn');
		const btnText = document.getElementById('walletBtnText');
		
		// 1. æ£€æŸ¥æ˜¯å¦æ­£åœ¨åŠ è½½æ•°æ®
		const loadingOverlay = document.getElementById('globalLoading');
		if (loadingOverlay && loadingOverlay.style.display === 'flex') {
			devLog('æ­£åœ¨åŠ è½½ä¸­ï¼Œæç¤ºç”¨æˆ·');
			showMessage('â³ æ•°æ®åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...', 'info');
			return;
		}
		
		// 2. åˆ¤æ–­æ˜¯å¦å·²è¿æ¥ï¼šæŒ‰é’®æ˜¾ç¤ºåœ°å€æ ¼å¼ï¼ˆåŒ…å«...å°±æ˜¯æ ¼å¼åŒ–åçš„åœ°å€ï¼‰
		const isBtnShowingAddress = btnText.textContent.includes('...');
		
		// 3. å·²è¿æ¥æ—¶å¤åˆ¶åœ°å€
		if (isBtnShowingAddress && (web3Manager.account || userState.address)) {
			devLog('å·²è¿æ¥é’±åŒ…ï¼Œæ‰§è¡Œå¤åˆ¶åœ°å€æ“ä½œ');
			
			const addressToCopy = web3Manager.account || userState.address;
			
			try {
				// å¤åˆ¶åœ°å€åˆ°å‰ªè´´æ¿
				await navigator.clipboard.writeText(addressToCopy);
				
				// ä¿å­˜åŸå§‹æŒ‰é’®çŠ¶æ€
				const originalText = btnText.textContent;
				const originalBackground = btn.style.background;
				const originalBorder = btn.style.border;
				const originalColor = btn.style.color;
				
				// æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è§†è§‰åé¦ˆ
				btnText.textContent = 'âœ… å·²å¤åˆ¶';
				btn.style.background = 'linear-gradient(135deg, rgba(34, 197, 94, 0.3) 0%, rgba(21, 128, 61, 0.3) 100%)';
				btn.style.border = '1px solid rgba(34, 197, 94, 0.5)';
				btn.style.color = '#22c55e';
				
				// æ˜¾ç¤ºæˆåŠŸæç¤º
				showMessage('åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
				
				// 1.5ç§’åæ¢å¤åŸçŠ¶
				setTimeout(() => {
					btnText.textContent = originalText;
					btn.style.background = originalBackground || 'linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(217, 70, 239, 0.2) 100%)';
					btn.style.border = originalBorder || '1px solid rgba(168, 85, 247, 0.5)';
					btn.style.color = originalColor || '#a855f7';
				}, 1500);
				
			} catch (error) {
				console.error('å¤åˆ¶å¤±è´¥:', error);
				// å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œæ˜¾ç¤ºåœ°å€
				const shortAddress = formatWalletAddress(addressToCopy);
				showMessage(`å¤åˆ¶å¤±è´¥ï¼Œåœ°å€ï¼š${shortAddress}`, 'error');
			}
			
		} else {
			// 4. æœªè¿æ¥æ—¶æ‰§è¡Œè¿æ¥æ“ä½œ
			devLog('æ‰§è¡Œè¿æ¥æ“ä½œ');
			
			try {
				showLoading('è¿æ¥é’±åŒ…ä¸­...');
				btn.disabled = true;
				btnText.textContent = 'è¿æ¥ä¸­...';
				
				if (digitRoller) {
					digitRoller = null;
				}
				
				await web3Manager.connect();
				
				userState.address = web3Manager.account;
				userState.connected = true;
				
				// âœ… å…³é”®ï¼šä½¿ç”¨ formatWalletAddress å‡½æ•°æ ¼å¼åŒ–åœ°å€æ˜¾ç¤º
				btnText.textContent = formatWalletAddress(web3Manager.account);
				
				await updateUI();
				
				hideLoading();
				devLog('é’±åŒ…è¿æ¥æˆåŠŸ');
				
			} catch (error) {
				console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
				hideLoading();
				btnText.textContent = 'è¿æ¥é’±åŒ…';
				showMessage('è¿æ¥å¤±è´¥: ' + (error.message || error), 'error');
				
			} finally {
				btn.disabled = false;
			}
		}
	}
	async function disconnectWallet() {
		try {
			devLog('å¼€å§‹æ–­å¼€é’±åŒ…');
			
			if (window.interestUpdateInterval) {
				clearInterval(window.interestUpdateInterval);
				window.interestUpdateInterval = null;
			}
			
			const valueElement = document.getElementById('interestValue');
			if (valueElement) {
				valueElement.innerHTML = '-- æœªå¼€å¯ --';
				valueElement.style.display = 'inline';
				valueElement.style.fontFamily = '-apple-system, BlinkMacSystemFont, sans-serif';
				valueElement.classList.remove('digit-roller-active');
			}
			
			if (typeof digitRoller !== 'undefined' && digitRoller !== null) {
				try {
					if (typeof digitRoller.destroy === 'function') {
						digitRoller.destroy();
					}
				} catch (e) {
					devLog('æ¸…ç†æ»šåŠ¨å™¨æ—¶å‡ºé”™', e);
				}
				digitRoller = null;
			}
			
			web3Manager.isConnected = false;
			web3Manager.account = null;
			
			userState.connected = false;
			userState.address = '';
			userState.hasReferrer = false;
			userState.isCommunity = false;
			userState.interestActivated = false;
			userState.vidBalance = 0;
			userState.usdtBalance = 0;
			userState.communityCount = 0;
			
			balances = { bnb: '0.00', vid: '0.00', usdt: '0.00', vollar: '0.00' };
			
			document.getElementById('vollarBalance').innerHTML = '0';
			document.getElementById('availableBalance').innerHTML = '0 VID';
			document.getElementById('willReceiveValue').innerHTML = '0';
			document.getElementById('resonateInput').value = '';
			
			updateInterestButton(true);
			
			// âœ… ä¿®æ­£ï¼šè´¦æˆ·æ–­å¼€æ—¶åº”è¯¥é‡ç½®é’±åŒ…æŒ‰é’®æ–‡æœ¬
			document.getElementById('walletBtnText').textContent = 'è¿æ¥é’±åŒ…';
			
			devLog('é’±åŒ…å·²å®Œå…¨æ–­å¼€');
			
		} catch (error) {
			console.error('æ–­å¼€é’±åŒ…æ—¶å‡ºé”™:', error);
		}
	}


	// é€šç”¨æç¤ºå‡½æ•°
	function showMessage(message, type = 'success') {
		const colors = {
			success: {
				bg: 'linear-gradient(135deg, rgba(34, 197, 94, 0.95) 0%, rgba(21, 128, 61, 0.95) 100%)',
				icon: 'âœ…',
				border: 'rgba(34, 197, 94, 0.5)'
			},
			error: {
				bg: 'linear-gradient(135deg, rgba(239, 68, 68, 0.95) 0%, rgba(185, 28, 28, 0.95) 100%)',
				icon: 'âŒ',
				border: 'rgba(239, 68, 68, 0.5)'
			},
			info: {
				bg: 'linear-gradient(135deg, rgba(59, 130, 246, 0.95) 0%, rgba(29, 78, 216, 0.95) 100%)',
				icon: 'â„¹ï¸',
				border: 'rgba(59, 130, 246, 0.5)'
			},
			warning: {
				bg: 'linear-gradient(135deg, rgba(245, 158, 11, 0.95) 0%, rgba(180, 83, 9, 0.95) 100%)',
				icon: 'âš ï¸',
				border: 'rgba(245, 158, 11, 0.5)'
			}
		};
		
		const config = colors[type] || colors.info;
		
		// æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æç¤ºæ¡†
		const existingToast = document.querySelector('.message-toast');
		if (existingToast) {
			existingToast.remove();
		}
		
		// åˆ›å»ºæç¤ºå…ƒç´ 
		const toast = document.createElement('div');
		toast.className = 'message-toast';
		toast.innerHTML = `
			<div style="
				position: fixed;
				top: 80px;
				left: 50%;
				transform: translateX(-50%);
				background: ${config.bg};
				color: white;
				padding: 12px 24px;
				border-radius: 12px;
				font-size: 14px;
				font-weight: 600;
				z-index: 10000;
				backdrop-filter: blur(10px);
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
				border: 1px solid ${config.border};
				display: flex;
				align-items: center;
				gap: 8px;
				animation: toastSlideIn 0.3s ease-out;
				white-space: nowrap;
				max-width: 80%;
				word-wrap: break-word;
			">
				<span style="font-size: 18px;">${config.icon}</span>
				<span>${message}</span>
			</div>
		`;
		
		document.body.appendChild(toast);
		
		// æ·»åŠ åŠ¨ç”»æ ·å¼ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
		if (!document.querySelector('#toast-styles')) {
			const style = document.createElement('style');
			style.id = 'toast-styles';
			style.textContent = `
				@keyframes toastSlideIn {
					from {
						opacity: 0;
						transform: translateX(-50%) translateY(-20px);
					}
					to {
						opacity: 1;
						transform: translateX(-50%) translateY(0);
					}
				}
				
				@keyframes toastSlideOut {
					from {
						opacity: 1;
						transform: translateX(-50%) translateY(0);
					}
					to {
						opacity: 0;
						transform: translateX(-50%) translateY(-20px);
					}
				}
			`;
			document.head.appendChild(style);
		}
		
		// æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„æ˜¾ç¤ºæ—¶é—´
		const duration = type === 'error' ? 3000 : 2000;
		
		setTimeout(() => {
			toast.style.animation = 'toastSlideOut 0.3s ease-out forwards';
			setTimeout(() => toast.remove(), 300);
		}, duration);
	}

    async function updateUI() {
        if (!web3Manager.account) {
            devLog('æœªè¿æ¥é’±åŒ…ï¼Œè·³è¿‡UIæ›´æ–°');
            return;
        }
        
        devLog('å¼€å§‹æ›´æ–°UI');
        
        try {
            showLoading('åŠ è½½æ•°æ®ä¸­...');
            
            await Promise.all([
                loadBalances(),
                loadContractData()
            ]);
            
            await updateBalanceDisplay();
            
            document.getElementById('resonateInput').value = '';
            calculateResonate();
            
            hideLoading();
            
            devLog('UIæ›´æ–°å®Œæˆ');
            
        } catch (error) {
            console.error('æ›´æ–°UIå¤±è´¥:', error);
            hideLoading();
            alert('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
        }
    }

    async function loadBalances() {
        try {
            devLog('å¼€å§‹åŠ è½½ä½™é¢');
            
            const [bnbBalance, vidBalance, usdtBalance, vollarBalance] = await Promise.all([
                web3Manager.getBNBBalance(),
                web3Manager.getTokenBalance(CONFIG.CONTRACTS.VID, CONFIG.DECIMALS.VID),
                web3Manager.getTokenBalance(CONFIG.CONTRACTS.USDT, CONFIG.DECIMALS.USDT),
                web3Manager.getTokenBalance(CONFIG.CONTRACTS.TokenBank, CONFIG.DECIMALS.Vollar)
            ]);
            
            devLog('ä½™é¢æ•°æ®', { bnb: bnbBalance, vid: vidBalance, usdt: usdtBalance, vollar: vollarBalance });
            
            balances = {
                bnb: bnbBalance,
                vid: vidBalance,
                usdt: usdtBalance,
                vollar: vollarBalance
            };
            
            const vollarNum = parseFloat(vollarBalance) || 0;
            const vidNum = parseFloat(vidBalance) || 0;
            const usdtNum = parseFloat(usdtBalance) || 0;
            
            userState.vidBalance = vidNum;
            userState.usdtBalance = usdtNum;
            
            document.getElementById('vollarBalance').innerHTML = formatVollarBalance(vollarNum);
            
        } catch (error) {
            console.error('åŠ è½½ä½™é¢å¤±è´¥:', error);
            throw error;
        }
    }

    async function loadContractData() {
        try {
            devLog('å¼€å§‹åŠ è½½åˆçº¦æ•°æ®');
            const contract = web3Manager.getContract(TOKENBANK_ABI, CONFIG.CONTRACTS.TokenBank);
            
            if (!contract) {
                console.error('åˆçº¦å¯¹è±¡åˆ›å»ºå¤±è´¥');
                return;
            }
			
			try {
			    const gr = await contract.methods.getGlobalRankingInfo().call();
			    userState.communityCount = Number(gr.totalGlobalCommunities) || 0;
			    devLog('å…¨ç½‘ç¤¾åŒºæ•°é‡', userState.communityCount);
			} catch {
			    devLog('è·å–ç¤¾åŒºæ•°é‡å¤±è´¥');
			    userState.communityCount = 0;
			}
			
            try {
                const totalSupplyWei = await contract.methods.totalSupply().call();
                userState.totalSupply = parseFloat(totalSupplyWei);
                devLog('Vollaræ€»é‡ä¾›åº”', userState.totalSupply / 1e6);
            } catch (error) {
                devLog('è·å–æ€»é‡å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                userState.totalSupply = 15000000e6;
            }
            
            let mintRate = 11111;
            try {
                const rateStats = await contract.methods.getRateStats().call();
                mintRate = Math.min(parseFloat(rateStats.mintRate) || 11111, 11111);
                devLog('å®æ—¶é“¸é€ æ±‡ç‡', mintRate);
            } catch (error) {
                devLog('è·å–æ±‡ç‡å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
            }
            
            userState.currentMintRate = mintRate;
            document.getElementById('exchangeRate').innerHTML = 
                `é“¸é€ æ±‡ç‡ <span class="rate-number">1:${formatNumber(mintRate)}</span>`;
            
            let hasInterest = false;
            try {
                hasInterest = await contract.methods.myInterestPermission().call({
                    from: web3Manager.account
                });
                devLog('ç”Ÿæ¯æƒé™', hasInterest);
            } catch (error) {
                devLog('è·å–ç”Ÿæ¯æƒé™å¤±è´¥');
            }
            userState.interestActivated = hasInterest;
            
            try {
                const isValid = await contract.methods.checkRefValid(web3Manager.account).call();
                userState.hasReferrer = isValid;
                devLog('æ¨èå…³ç³»çŠ¶æ€', userState.hasReferrer);
            } catch (error) {
                devLog('è·å–æ¨èå…³ç³»å¤±è´¥');
            }
            
            try {
                const isCommunity = await contract.methods.amICommunityMember().call({
                    from: web3Manager.account
                });
                userState.isCommunity = isCommunity;
                devLog('æ˜¯å¦ç¤¾åŒºæˆå‘˜', isCommunity);
            } catch (error) {
                devLog('è·å–ç¤¾åŒºçŠ¶æ€å¤±è´¥');
            }
            
			updateInterestButton();
			
			if (hasInterest) {
				setTimeout(() => {
					startInterestUpdate();
				}, 100);
			}

            devLog('åˆçº¦æ•°æ®åŠ è½½å®Œæˆ');
            
        } catch (error) {
            console.error('åŠ è½½åˆçº¦æ•°æ®å¤±è´¥:', error);
        }
    }

	function updateInterestButton(forceReset = false) {
		const section = document.getElementById('interestSection');
		const btn = document.getElementById('interestBtn');
		const value = document.getElementById('interestValue');
		const countdown = document.getElementById('interestCountdown');
		
		devLog('æ›´æ–°åˆ©æ¯æŒ‰é’®çŠ¶æ€', { activated: userState.interestActivated, forceReset });
		
		if (forceReset || !userState.interestActivated) {
			section.classList.add('inactive');
			btn.classList.add('activate');
			btn.textContent = 'å¼€å¯ç”Ÿæ¯';
			
			if (value) {
				value.innerHTML = '-- æœªå¼€å¯ --';
				value.style.display = 'inline';
				value.style.fontFamily = "'Courier New', monospace";
				value.style.color = 'rgba(255, 255, 255, 0.4)';
				value.style.fontSize = '22px';
				value.style.fontWeight = '700';
			}
			
			if (countdown) {
				countdown.style.display = 'none';
			}
			
			if (digitRoller) {
				try {
					digitRoller.destroy();
				} catch (e) {
					devLog('é”€æ¯æ»šåŠ¨å™¨æ—¶å‡ºé”™', e);
				}
				digitRoller = null;
			}
			
			if (window.interestUpdateInterval) {
				clearInterval(window.interestUpdateInterval);
				window.interestUpdateInterval = null;
			}
			
		} else {
			section.classList.remove('inactive');
			btn.classList.remove('activate');
			btn.textContent = 'é¢†å–';
			
			if (typeof initDigitRoller === 'function') {
				if (!digitRoller) {
					initDigitRoller();
				}
				if (digitRoller) {
					digitRoller.activate();
					digitRoller.update(0);
				}
			}
			
			if (countdown) {
				countdown.style.display = 'block';
			}
		}
	}

    async function switchTab(token) {
        devLog('åˆ‡æ¢åˆ°æ ‡ç­¾', token);
        
        userState.currentToken = token;
        
        document.querySelectorAll('.tab-btn').forEach(tab => {
            tab.classList.toggle('active', tab.textContent === token);
        });

        try {
            await updateBalanceDisplay();
            
            document.getElementById('resonateInput').value = '';
            calculateResonate();
            
        } catch (error) {
            console.error('åˆ‡æ¢æ ‡ç­¾å¤±è´¥:', error);
        }
    }

    async function updateBalanceDisplay() {
        const token = userState.currentToken;
        
        if (!balances || (!balances.vid && !balances.usdt)) {
            devLog('ä½™é¢æ•°æ®æœªåŠ è½½ï¼Œé‡æ–°åŠ è½½');
            await loadBalances();
        }
        
        let displayBalance;
        if (token === 'VID') {
            displayBalance = parseFloat(balances.vid) || 0;
        } else {
            displayBalance = parseFloat(balances.usdt) || 0;
        }
        
        document.getElementById('availableBalance').innerHTML = 
            formatBalance(displayBalance, 2) + ' ' + token;
    }

    // âœ… å®Œå…¨é‡å†™çš„iOSé”®ç›˜å¤„ç†
	function initKeyboardHandler() {
	    if (!isMobile) {
	        devLog('PCç«¯ï¼Œè·³è¿‡é”®ç›˜å¤„ç†');
	        return;
	    }
	    
	    devLog('ç§»åŠ¨ç«¯ï¼Œå¯ç”¨é”®ç›˜å¤„ç†', { isIOS });
	    
	    const input = document.getElementById('resonateInput');
	    const body = document.body;
	    
	    if (!input) return;
	    
	    let isKeyboardOpen = false;
	    
	    // ============ iOSä¸“ç”¨å¤„ç† ============
	    if (isIOS) {
	        devLog('iOSè®¾å¤‡ï¼Œä½¿ç”¨ä¸“ç”¨é”®ç›˜å¤„ç†');
	        
	        // æ–¹æ³•1ï¼šFocusäº‹ä»¶ç«‹å³éšè—
	        input.addEventListener('focus', function() {
	            devLog('iOSè¾“å…¥æ¡†è·å¾—ç„¦ç‚¹');
	            body.classList.add('keyboard-open');
	            body.classList.add('ios-keyboard-open');
	            body.classList.add('input-focused');
	            isKeyboardOpen = true;
	            
	            // å¼ºåˆ¶è§¦å‘é‡ç»˜
	            setTimeout(() => {
	                const nav = document.querySelector('.bottom-nav');
	                if (nav) {
	                    nav.style.cssText = `
	                        display: none !important;
	                        visibility: hidden !important;
	                        transform: translateY(150%) !important;
	                        position: fixed !important;
	                        bottom: -100px !important;
	                        pointer-events: none !important;
	                        z-index: -1 !important;
	                    `;
	                }
	            }, 50);
				
				// âœ… æ–°å¢ï¼šiOSè‡ªåŠ¨æ»šåŠ¨åˆ°"å°†è·å¾—Vollar"å¯è§
				setTimeout(() => {
					const willReceiveRow = document.querySelector('.will-receive-row');
					if (willReceiveRow) {
						devLog('iOSæ»šåŠ¨åˆ°"å°†è·å¾—Vollar"');
						willReceiveRow.scrollIntoView({
							behavior: 'smooth',
							block: 'center'
						});
					}
				}, 400);
				
	        });
	        
	        input.addEventListener('blur', function() {
	            devLog('iOSè¾“å…¥æ¡†å¤±å»ç„¦ç‚¹');
	            
	            setTimeout(() => {
	                body.classList.remove('keyboard-open');
	                body.classList.remove('ios-keyboard-open');
	                body.classList.remove('input-focused');
	                isKeyboardOpen = false;
	                
	                const nav = document.querySelector('.bottom-nav');
	                if (nav) {
	                    nav.style.cssText = '';
	                }
	            }, 300);
	        });
	        
	        // æ–¹æ³•2ï¼šVisualViewport API
	        if (window.visualViewport) {
	            devLog('iOSæ”¯æŒVisualViewport API');
	            
	            let lastHeight = window.visualViewport.height;
	            
	            window.visualViewport.addEventListener('resize', () => {
	                const currentHeight = window.visualViewport.height;
	                const heightDiff = lastHeight - currentHeight;
	                
	                devLog('iOS VisualViewportå˜åŒ–', { 
	                    lastHeight, 
	                    currentHeight, 
	                    diff: heightDiff 
	                });
	                
	                if (heightDiff > 100) {
	                    body.classList.add('keyboard-open');
	                    body.classList.add('ios-keyboard-open');
	                    isKeyboardOpen = true;
	                } 
	                else if (heightDiff < -50) {
	                    setTimeout(() => {
	                        body.classList.remove('keyboard-open');
	                        body.classList.remove('ios-keyboard-open');
	                        isKeyboardOpen = false;
	                    }, 200);
	                }
	                
	                lastHeight = currentHeight;
	            });
	            
	            window.visualViewport.addEventListener('scroll', () => {
	                if (document.activeElement === input) {
	                    body.classList.add('keyboard-open');
	                    body.classList.add('ios-keyboard-open');
	                }
	            });
	        }
	        
	        // æ–¹æ³•3ï¼šç›‘å¬çª—å£ç„¦ç‚¹å˜åŒ–
	        window.addEventListener('focusin', (e) => {
	            if (e.target === input) {
	                devLog('iOSçª—å£ç„¦ç‚¹è¿›å…¥è¾“å…¥æ¡†');
	                body.classList.add('keyboard-open');
	                body.classList.add('ios-keyboard-open');
	                body.classList.add('input-focused');
	            }
	        });
	        
	        window.addEventListener('focusout', (e) => {
	            if (e.target === input) {
	                devLog('iOSçª—å£ç„¦ç‚¹ç¦»å¼€è¾“å…¥æ¡†');
	                setTimeout(() => {
	                    body.classList.remove('keyboard-open');
	                    body.classList.remove('ios-keyboard-open');
	                    body.classList.remove('input-focused');
	                }, 300);
	            }
	        });
	        
	    } 
	    // ============ Androidå¤„ç† ============
	    else {
	        devLog('Androidè®¾å¤‡ï¼Œä½¿ç”¨æ ‡å‡†é”®ç›˜å¤„ç†');
	        
	        let originalViewportHeight = window.innerHeight;
	        
	        window.addEventListener('resize', function() {
	            const newHeight = window.innerHeight;
	            const heightDiff = originalViewportHeight - newHeight;
	            
	            devLog('Androidçª—å£resize', { originalViewportHeight, newHeight, heightDiff });
	            
	            if (heightDiff > 250) {
	                if (!isKeyboardOpen) {
	                    body.classList.add('keyboard-open');
	                    isKeyboardOpen = true;
	                }
	            } else if (heightDiff < 50 && isKeyboardOpen) {
	                body.classList.remove('keyboard-open');
	                isKeyboardOpen = false;
	            }
	            
	            originalViewportHeight = newHeight;
	        });
	        
	        input.addEventListener('focus', function() {
	            setTimeout(() => {
	                if (!isKeyboardOpen) {
	                    body.classList.add('keyboard-open');
	                    isKeyboardOpen = true;
	                }
	            }, 300);
	        });
	        
	        input.addEventListener('blur', function() {
	            setTimeout(() => {
	                if (isKeyboardOpen) {
	                    body.classList.remove('keyboard-open');
	                    isKeyboardOpen = false;
	                }
	            }, 200);
	        });
	    }
	    
	    // ============ é€šç”¨å¤„ç† ============
	    
	    document.addEventListener('touchstart', function(e) {
	        if (isKeyboardOpen && 
	            e.target !== input && 
	            !input.contains(e.target)) {
	            devLog('ç‚¹å‡»å…¶ä»–åŒºåŸŸï¼Œå…³é—­é”®ç›˜');
	            input.blur();
	        }
	    }, { passive: true });
	    
	    document.addEventListener('visibilitychange', function() {
	        if (document.hidden && isKeyboardOpen) {
	            devLog('é¡µé¢éšè—ï¼Œé‡ç½®é”®ç›˜çŠ¶æ€');
	            body.classList.remove('keyboard-open');
	            body.classList.remove('ios-keyboard-open');
	            body.classList.remove('input-focused');
	            isKeyboardOpen = false;
	        }
	    });
	}

	function showKeyboard() {
	    devLog('æ˜¾ç¤ºé”®ç›˜å¤„ç†');
	    document.body.classList.add('keyboard-open');
	}

	function hideKeyboard() {
	    devLog('éšè—é”®ç›˜å¤„ç†');
	    document.body.classList.remove('keyboard-open');
	}

    function calculateResonate() {
        const input = document.getElementById('resonateInput');
        const amount = parseFloat(input.value.replace(/,/g, '')) || 0;
        const token = userState.currentToken;
        const wrapper = document.getElementById('inputWrapper');
        const btn = document.getElementById('resonateBtn');
        
        devLog('è®¡ç®—å…±æŒ¯', { token, amount, rate: userState.currentMintRate });
        
        let balance;
        if (token === 'VID') {
            balance = parseFloat(balances.vid) || 0;
        } else {
            balance = parseFloat(balances.usdt) || 0;
        }
        
        let rate;
        let baseVollar = 0;
        let subsidyVollar = 0;
        let totalVollar = 0;
        
        if (token === 'VID') {
            rate = userState.currentMintRate || 11111;
            baseVollar = amount * rate;
            
            if (userState.isCommunity) {
                const subsidyRate = getSubsidyRate(userState.totalSupply);
                subsidyVollar = baseVollar * subsidyRate / 100;
            }
            
            totalVollar = baseVollar + subsidyVollar;
            
            document.getElementById('exchangeRate').innerHTML = 
                `é“¸é€ æ±‡ç‡ <span class="rate-number">1:${formatNumber(rate)}</span>`;
        } else {
            rate = 1;
            baseVollar = amount;
            
            if (userState.isCommunity && userState.totalSupply < 21000000e6) {
                subsidyVollar = baseVollar * 25 / 100;
            }
            
            totalVollar = baseVollar + subsidyVollar;
            
            document.getElementById('exchangeRate').innerHTML = 
                `é“¸é€ æ±‡ç‡ <span class="rate-number">1:1</span>`;
        }
        
        let displayHTML = formatNumber(totalVollar, 2);
        
        if (subsidyVollar > 0) {
            displayHTML += `<div style="font-size: 12px; color: #10b981; display: inline-block; margin-left: 10px;">
                (è¡¥è´´+${formatNumber(subsidyVollar, 2)})
            </div>`;
        }
        
        document.getElementById('willReceiveValue').innerHTML = displayHTML;
        
        wrapper.classList.remove('error');
        
        const minAmount = token === 'VID' ? 0.1 : 1;
        const maxAmount = token === 'VID' ? 10000 : 1000000;
        
        if (amount < minAmount) {
            wrapper.classList.add('error');
            btn.disabled = true;
            btn.textContent = `æœ€å° ${minAmount} ${token}`;
            return;
        }
        
        if (amount > maxAmount) {
            wrapper.classList.add('error');
            btn.disabled = true;
            btn.textContent = `æœ€å¤§ ${formatNumber(maxAmount)} ${token}`;
            return;
        }
        
        if (amount > balance) {
            wrapper.classList.add('error');
            btn.disabled = true;
            btn.textContent = 'ä½™é¢ä¸è¶³';
            return;
        }
        
        if (userState.totalSupply >= 100000000000e6) {
            wrapper.classList.add('error');
            btn.disabled = true;
            btn.textContent = 'âŒ å·²è¾¾1000äº¿ä¸Šé™';
            return;
        }
        
        if (token === 'VID' && userState.isCommunity) {
			const genesisExchangeTime = 1767232800;
			const currentTime = Math.floor(Date.now() / 1000);
			if (currentTime < genesisExchangeTime) {
				wrapper.classList.add('error');
				btn.disabled = true;
				const remaining = genesisExchangeTime - currentTime;
				btn.textContent = `${Math.floor(remaining / 86400)}å¤©${Math.floor((remaining % 86400) / 3600)}æ—¶åå¼€å¯åˆ›ä¸–å…±æŒ¯`;
				return;
			}
			if (userState.communityCount < 10) {
				wrapper.classList.add('error');
				btn.disabled = true;
				btn.textContent = `éœ€å…¨ç½‘â‰¥10ç¤¾åŒº (${userState.communityCount}/10)`;
				return;
			}
		}
        
        if (amount > 0) {
            btn.disabled = false;
            btn.textContent = 'ç¡®è®¤å…±æŒ¯';
        } else {
            btn.disabled = true;
            btn.textContent = 'è¯·è¾“å…¥é‡‘é¢';
        }
    }
    
    function getSubsidyRate(totalSupply) {
        const millions = totalSupply / 1e12;
        
        if (millions < 2) {
            return 900;
        } else if (millions < 10) {
            return 1000 - (millions * 100);
        } else if (millions < 21) {
            return 25;
        } else if (millions < 100) {
            return 10;
        } else {
            return 0;
        }
    }

	// ==================== ä¿®æ”¹ setMaxAmount å‡½æ•° ====================

	function setMaxAmount() {
		const token = userState.currentToken;
		let balance;
		
		if (token === 'VID') {
			balance = parseFloat(balances.vid) || 0;
		} else {
			balance = parseFloat(balances.usdt) || 0;
		}
		
		// ä½¿ç”¨å‘ä¸‹èˆå…¥çš„ä½™é¢
		const truncatedBalance = getTruncatedBalance(balance, 2);
		const maxAllowed = token === 'VID' ? 10000 : 1000000;
		const maxAmount = Math.min(truncatedBalance, maxAllowed);
		
		// ç¡®ä¿æœ€å¤šåªæ˜¾ç¤º2ä½å°æ•°
		document.getElementById('resonateInput').value = maxAmount.toFixed(2);
		calculateResonate();
	}

    async function handleResonateVID() {
        const input = document.getElementById('resonateInput');
        const amount = input.value;
        const btn = document.getElementById('resonateBtn');
        
        devLog('å¼€å§‹VIDå…±æŒ¯', amount);
        
        if (!web3Manager.account) {
            alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            return;
        }
        
        if (!userState.hasReferrer) {
            showBindModal();
            return;
        }
        
        if (!amount || parseFloat(amount) <= 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°é‡');
            return;
        }
        
        if (btn.disabled) return;
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = 'å¤„ç†ä¸­...';
        
        try {
            showLoading('å¤„ç†ä¸­...');
            
            const contract = web3Manager.getContract(TOKENBANK_ABI, CONFIG.CONTRACTS.TokenBank);
            const amountWei = toContractAmount(amount, CONFIG.DECIMALS.VID);
            
            const allowance = await web3Manager.getAllowance(
                CONFIG.CONTRACTS.VID,
                CONFIG.CONTRACTS.TokenBank
            );
            
            if (BigInt(allowance) < BigInt(amountWei)) {
                devLog('éœ€è¦æˆæƒ');
                await web3Manager.approve(
                    CONFIG.CONTRACTS.VID,
                    CONFIG.CONTRACTS.TokenBank,
                    amountWei
                );
            }
        
			// ä½¿ç”¨ç»Ÿä¸€çš„ sendTransaction æ–¹æ³•
			await web3Manager.sendTransaction(
				contract,
				'resonateVID',
				[amountWei]  // å…±æŒ¯æ•°é‡å‚æ•°
			);
            
            hideLoading();
            showSuccess('å…±æŒ¯æˆåŠŸï¼');
            
            await updateUI();
            
            input.value = '';
            
        } catch (error) {
            console.error('å…±æŒ¯å¤±è´¥:', error);
            hideLoading();
            if (error.code === 4001) {
                showError('ç”¨æˆ·å–æ¶ˆäº¤æ˜“');
            } else {
                showError('äº¤æ˜“å¤±è´¥ï¼š' + error.message);
            }
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    async function handleResonateUSDT() {
        const input = document.getElementById('resonateInput');
        const amount = input.value;
        const btn = document.getElementById('resonateBtn');
        
        devLog('å¼€å§‹USDTå…±æŒ¯', amount);
        
        if (!web3Manager.account) {
            alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            return;
        }
        
        if (!userState.hasReferrer) {
            showBindModal();
            return;
        }
        
        if (!amount || parseFloat(amount) <= 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°é‡');
            return;
        }
        
        if (btn.disabled) return;
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = 'å¤„ç†ä¸­...';
        
        try {
            showLoading('å¤„ç†ä¸­...');
            
            const contract = web3Manager.getContract(TOKENBANK_ABI, CONFIG.CONTRACTS.TokenBank);
            const amountWei = toContractAmount(amount, CONFIG.DECIMALS.USDT);
            
            const allowance = await web3Manager.getAllowance(
                CONFIG.CONTRACTS.USDT,
                CONFIG.CONTRACTS.TokenBank
            );
            
            if (BigInt(allowance) < BigInt(amountWei)) {
                devLog('éœ€è¦æˆæƒ');
                await web3Manager.approve(
                    CONFIG.CONTRACTS.USDT,
                    CONFIG.CONTRACTS.TokenBank,
                    amountWei
                );
            }
            
			// ä½¿ç”¨ç»Ÿä¸€çš„ sendTransaction æ–¹æ³•
			await web3Manager.sendTransaction(
				contract,
				'resonateUSDT',
				[amountWei]  // å…±æŒ¯æ•°é‡å‚æ•°
			);
            
            hideLoading();
            showSuccess('å…±æŒ¯æˆåŠŸï¼');
            
            await updateUI();
            
            input.value = '';
            
        } catch (error) {
            console.error('å…±æŒ¯å¤±è´¥:', error);
            hideLoading();
            if (error.code === 4001) {
                showError('ç”¨æˆ·å–æ¶ˆäº¤æ˜“');
            } else {
                showError('äº¤æ˜“å¤±è´¥ï¼š' + error.message);
            }
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    async function handleResonate() {
        if (!web3Manager.account) {
            alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            return;
        }
        
        devLog('æ£€æŸ¥æ¨èå…³ç³»', userState.hasReferrer);
        
        if (!userState.hasReferrer) {
            showBindModal();
            return;
        }
        
        const token = userState.currentToken;
        
        if (token === 'VID') {
            await handleResonateVID();
        } else {
            await handleResonateUSDT();
        }
    }

	async function activateInterest() {
		devLog('å¼€å§‹æ¿€æ´»ç”Ÿæ¯');
		
		if (!web3Manager.account) {
			alert('è¯·å…ˆè¿æ¥é’±åŒ…');
			return;
		}
		
		if (!userState.hasReferrer) {
			showBindModal();
			return;
		}
		
		const vollarBalance = parseFloat(balances.vollar) || 0;
		devLog('æ£€æŸ¥Vollarä½™é¢', { balance: vollarBalance, required: 100 });
		
		if (vollarBalance < 100) {
			showError(`ä½™é¢ä¸è¶³<br>éœ€è¦è‡³å°‘ 100 Vollar<br>å½“å‰ä½™é¢ï¼š${vollarBalance.toFixed(2)} Vollar`);
			return;
		}
		
		try {
			showLoading('æ¿€æ´»ä¸­...');
			
			const contract = web3Manager.getContract(TOKENBANK_ABI, CONFIG.CONTRACTS.TokenBank);
			
			// ä½¿ç”¨ç»Ÿä¸€çš„ sendTransaction æ–¹æ³•
			await web3Manager.sendTransaction(
				contract,
				'interestSwitch',
				[]  // æ— å‚æ•°
			);
			
			hideLoading();
			showSuccess('âœ… ç”Ÿæ¯æ¿€æ´»æˆåŠŸï¼');
			
			userState.interestActivated = true;
			updateInterestButton();
			
			setTimeout(async () => {
				await updateUI();
			}, 2000);
			
		} catch (error) {
			console.error('æ¿€æ´»å¤±è´¥:', error);
			hideLoading();
			
			let errorMsg = 'æ¿€æ´»å¤±è´¥';
			
			if (error.code === 4001) {
				errorMsg = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';
			} else if (error.message.includes('InsufficientBalance') || 
					   error.message.includes('ERC20InsufficientBalance')) {
				errorMsg = 'Vollarä½™é¢ä¸è¶³ï¼Œéœ€è¦è‡³å°‘100 Vollar';
			} else if (error.message.includes('NoReferralProvided')) {
				errorMsg = 'æœªç»‘å®šæ¨èå…³ç³»';
			} else if (error.message.includes('InterestEarningActivated')) {
				errorMsg = 'ç”Ÿæ¯å·²æ¿€æ´»ï¼Œæ— éœ€é‡å¤æ¿€æ´»';
			} else {
				errorMsg = `æ¿€æ´»å¤±è´¥ï¼š${error.message.substring(0, 100)}`;
			}
			
			showError(errorMsg);
		}
	}

    async function claimInterest() {
        devLog('å¼€å§‹é¢†å–ç”Ÿæ¯');
        
        if (!web3Manager.account) {
            alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            return;
        }
        
        const vollarBalance = parseFloat(balances.vollar) || 0;
        if (vollarBalance < 0.1) {
            showError('ä½™é¢ä¸è¶³0.1 Vollarï¼Œæ— æ³•é¢†å–ç”Ÿæ¯');
            return;
        }
        
        try {
            showLoading('é¢†å–ä¸­...');
            
            const contract = web3Manager.getContract(TOKENBANK_ABI, CONFIG.CONTRACTS.TokenBank);
            
            const feeAmountWei = await contract.methods.getPayBNBFee().call();
          
			// ä½¿ç”¨ç»Ÿä¸€çš„ sendTransaction æ–¹æ³•
			await web3Manager.sendTransaction(
				contract,           // åˆçº¦å®ä¾‹
				'claimInterest',    // æ–¹æ³•å
				[],                 // æ— å‚æ•°
				{
					value: feeAmountWei  // éœ€è¦æ”¯ä»˜çš„BNB
				}
			);
            
            hideLoading();
            showSuccess('é¢†å–æˆåŠŸï¼');
            
            if (digitRoller) {
                digitRoller.update(0);
            }
            
            setTimeout(async () => {
                await updateUI();
            }, 2000);
            
        } catch (error) {
            console.error('é¢†å–å¤±è´¥:', error);
            hideLoading();
            showError('é¢†å–å¤±è´¥ï¼š' + error.message);
        }
    }

    async function handleInterestAction() {
        if (!web3Manager.account) {
            alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            return;
        }
        
        if (!userState.interestActivated) {
            await activateInterest();
        } else {
            await claimInterest();
        }
    }

	function startInterestUpdate() {
		devLog('å¼€å§‹åˆå§‹åŒ–ç”Ÿæ¯æ›´æ–°');
		
		if (window.interestUpdateInterval) {
			clearInterval(window.interestUpdateInterval);
			window.interestUpdateInterval = null;
		}
		
		if (typeof initDigitRoller === 'function') {
			if (!digitRoller) {
				initDigitRoller();
			}
			
			if (digitRoller && !digitRoller.isActive) {
				digitRoller.activate();
				digitRoller.update(0);
			}
		}
		
		if (!digitRoller || !digitRoller.isActive) {
			console.error('æ»šåŠ¨å™¨åˆå§‹åŒ–å¤±è´¥');
			const valueElement = document.getElementById('interestValue');
			if (valueElement) {
				valueElement.innerHTML = 'åŠ è½½ä¸­...';
			}
			return;
		}
		
		let state = {
			baseTotal: 0,
			perSecond: 0,
			interestStartTime: 0,
			lastSyncTime: 0,
			timeRemaining: 0
		};
		
		const syncFullData = async () => {
			try {
				const contract = web3Manager.getContract(TOKENBANK_ABI, CONFIG.CONTRACTS.TokenBank);
				
				const [totalWei, perSecondWei, timestamps] = await Promise.all([
					contract.methods.AmounttobeCollected().call({from: web3Manager.account}),
					contract.methods.AmountSecond().call({from: web3Manager.account}),
					contract.methods.getUserTimestamps().call({from: web3Manager.account})
				]);
				
				state.baseTotal = totalWei / 1e6;
				state.perSecond = perSecondWei / 1e6;
				state.interestStartTime = parseInt(timestamps[0]);
				state.lastSyncTime = Date.now();
				
				const currentTime = Math.floor(Date.now() / 1000);
				const elapsed = currentTime - state.interestStartTime;
				state.timeRemaining = Math.max(0, 30 * 24 * 3600 - elapsed);
				
				devLog('å®Œæ•´æ•°æ®åŒæ­¥å®Œæˆ');
				
			} catch (error) {
				console.error('åŒæ­¥æ•°æ®å¤±è´¥:', error);
			}
		};
		
		const formatTime = (seconds) => {
			const days = Math.floor(seconds / (24 * 3600));
			const hours = Math.floor((seconds % (24 * 3600)) / 3600);
			const minutes = Math.floor((seconds % 3600) / 60);
			const secs = seconds % 60;
			return `${days}å¤©${hours}æ—¶${minutes}åˆ†${secs}ç§’`;
		};
		
		const getUpdateInterval = () => {
			if (state.perSecond < 0.00001) {
				return 5000;
			} else if (state.perSecond < 0.0001) {
				return 2000;
			} else {
				return 1000;
			}
		};
		
		let lastUpdate = 0;
		
		const updateDisplay = () => {
			const now = Date.now();
			const interval = getUpdateInterval();
			
			if (now - lastUpdate < interval) {
				return;
			}
			lastUpdate = now;
			
			const elapsedSeconds = (Date.now() - state.lastSyncTime) / 1000;
			const currentTotal = state.baseTotal + (state.perSecond * elapsedSeconds);
			
			if (digitRoller && digitRoller.isActive) {
				digitRoller.update(currentTotal);
			}
			
			if (state.timeRemaining > 0) {
				state.timeRemaining = Math.max(0, state.timeRemaining - 1);
				const countdownEl = document.getElementById('interestCountdown');
				if (countdownEl) {
					countdownEl.textContent = `â±ï¸å°é¡¶: ${formatTime(state.timeRemaining)}`;
					countdownEl.style.display = 'block';
				}
			} else {
				const countdownEl = document.getElementById('interestCountdown');
				if (countdownEl) {
					countdownEl.textContent = 'â±ï¸ å·²è¾¾ä¸Šé™';
					countdownEl.style.display = 'block';
				}
			}
		};
		
		let lastFullSync = 0;
		window.interestUpdateInterval = setInterval(() => {
			if (!web3Manager.account || !userState.interestActivated) {
				clearInterval(window.interestUpdateInterval);
				window.interestUpdateInterval = null;
				return;
			}
			
			updateDisplay();
			
			const now = Date.now();
			
			if (now - lastFullSync > 30000) {
				syncFullData();
				lastFullSync = now;
			}
			
		}, 1000);
		
		syncFullData();
	}

    async function showBindModal() {
        document.getElementById('bindModal').classList.add('show');
        updateInputActionBtn();
        
        try {
            const contract = web3Manager.getContract(TOKENBANK_ABI, CONFIG.CONTRACTS.TokenBank);
            const feeAmountWei = await contract.methods.getPayBNBFee().call();
            const feeAmountBNB = web3Manager.web3.utils.fromWei(feeAmountWei, 'ether');
            document.getElementById('bindFee').textContent = `${feeAmountBNB} BNB`;
        } catch (error) {
            devLog('è·å–æ‰‹ç»­è´¹å¤±è´¥');
            document.getElementById('bindFee').textContent = '0.001 BNB (ä¼°ç®—)';
        }
    }

    function closeBindModal() {
        document.getElementById('bindModal').classList.remove('show');
        document.getElementById('referrerInput').value = '';
        document.getElementById('errorMsg').classList.remove('show');
        document.getElementById('referrerInput').classList.remove('error');
        document.getElementById('confirmBindBtn').disabled = false;
        document.getElementById('confirmBindBtn').textContent = 'ç¡®è®¤ç»‘å®š';
    }

    function updateInputActionBtn() {
        const input = document.getElementById('referrerInput');
        const btn = document.getElementById('inputActionBtn');
        
        if (input && btn) {
            if (input.value.trim()) {
                btn.textContent = 'æ¸…é™¤';
            } else {
                btn.textContent = 'ç²˜è´´';
            }
        }
    }

    async function handleInputAction() {
        const input = document.getElementById('referrerInput');
        const errorMsg = document.getElementById('errorMsg');
        
        if (input.value.trim()) {
            input.value = '';
            input.classList.remove('error');
            errorMsg.classList.remove('show');
        } else {
            try {
                const text = await navigator.clipboard.readText();
                if (text.match(/^0x[a-fA-F0-9]{40}$/)) {
                    input.value = text;
                    input.classList.remove('error');
                    errorMsg.classList.remove('show');
                } else {
                    errorMsg.textContent = 'âŒ ç²˜è´´å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„åœ°å€';
                    errorMsg.classList.add('show');
                }
            } catch (err) {
                console.error('ç²˜è´´å¤±è´¥:', err);
                alert('æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´');
            }
        }
        updateInputActionBtn();
    }

    function useDefaultAddress() {
        document.getElementById('referrerInput').value = CONFIG.CONTRACTS.TokenBank;
        document.getElementById('referrerInput').classList.remove('error');
        document.getElementById('errorMsg').classList.remove('show');
        updateInputActionBtn();
    }

    async function confirmBind() {
        const input = document.getElementById('referrerInput');
        const referrerAddress = input.value.trim();
        const errorMsg = document.getElementById('errorMsg');
        const confirmBtn = document.getElementById('confirmBindBtn');

        if (!referrerAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
            input.classList.add('error');
            errorMsg.textContent = 'âŒ åœ°å€æ ¼å¼é”™è¯¯';
            errorMsg.classList.add('show');
            return;
        }

        if (referrerAddress.toLowerCase() === web3Manager.account.toLowerCase()) {
            input.classList.add('error');
            errorMsg.textContent = 'âŒ ä¸èƒ½å°†è‡ªå·±ç»‘å®šä¸ºæ¨èäºº';
            errorMsg.classList.add('show');
            return;
        }

        devLog('å¼€å§‹ç»‘å®šæ¨èäºº', referrerAddress);
        
        try {
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'éªŒè¯ä¸­...';
            
            const contract = web3Manager.getContract(TOKENBANK_ABI, CONFIG.CONTRACTS.TokenBank);
            if (!contract) {
                throw new Error('åˆçº¦åˆå§‹åŒ–å¤±è´¥');
            }

            const isValidReferrer = await contract.methods.checkRefValid(referrerAddress).call();
            
            if (!isValidReferrer) {
                input.classList.add('error');
                errorMsg.textContent = 'âŒ æ¨èäººåœ°å€æ— æ•ˆï¼ˆè¯¥åœ°å€æœªç»‘å®šæ¨èå…³ç³»ï¼‰';
                errorMsg.classList.add('show');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'ç¡®è®¤ç»‘å®š';
                return;
            }
            
			confirmBtn.textContent = 'äº¤æ˜“ç¡®è®¤ä¸­...';

			const feeAmountWei = await contract.methods.getPayBNBFee().call();

			try {
				// ä½¿ç”¨ç»Ÿä¸€çš„ sendTransaction æ–¹æ³•
				await web3Manager.sendTransaction(
					contract,
					'bindReferral',
					[referrerAddress],  // æ¨èäººåœ°å€å‚æ•°
					{
						value: feeAmountWei  // éœ€è¦æ”¯ä»˜çš„BNB
					}
				);
			} catch (txError) {
				console.error('äº¤æ˜“å‘é€å¤±è´¥:', txError);
				throw txError; // é‡æ–°æŠ›å‡ºï¼Œè®©å¤–å±‚catchå¤„ç†
			}

			userState.hasReferrer = true;
			closeBindModal();

			showSuccess(`âœ… æ¨èå…³ç³»ç»‘å®šæˆåŠŸï¼`);

			// å¼‚æ­¥æ›´æ–°æ•°æ®
			setTimeout(async () => {
				try {
					await loadContractData();
					devLog('æ•°æ®æ›´æ–°å®Œæˆ');
				} catch (updateError) {
					console.error('æ›´æ–°æ•°æ®å¤±è´¥ï¼ˆä¸å½±å“äº¤æ˜“æˆåŠŸï¼‰:', updateError);
				}
			}, 2000);
            
        } catch (error) {
            console.error('ç»‘å®šäº¤æ˜“å¤±è´¥:', error);
            
            let errorMessage = 'âŒ äº¤æ˜“å¤±è´¥';
            
            if (error.code === 4001) {
                errorMessage = 'âŒ ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“';
            } else if (error.message.includes('NoBNB')) {
                errorMessage = 'âŒ æ‰‹ç»­è´¹ä¸è¶³ï¼Œè¯·ç¡®ä¿é’±åŒ…æœ‰è¶³å¤ŸBNB';
            } else if (error.message.includes('InvalidReferrer')) {
                errorMessage = 'âŒ æ¨èäººåœ°å€æ— æ•ˆ';
            } else {
                errorMessage = `âŒ äº¤æ˜“å¤±è´¥: ${error.message.substring(0, 80)}...`;
            }
            
            errorMsg.textContent = errorMessage;
            errorMsg.classList.add('show');
            
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'ç¡®è®¤ç»‘å®š';
        }
    }

    function switchPage(page) {
        const pages = {
            'home': 'index.html',
            'stats': 'data.html',
            'swap': 'exchange.html',
            'temple': 'temple.html'
        };
        
        if (pages[page]) {
            window.location.href = pages[page];
        }
    }

    function toggleLanguage() {
        alert('å¤šè¯­è¨€åŠŸèƒ½å¼€å‘ä¸­...');
    }

	function initUI() {
		devLog('åˆå§‹åŒ–UI');
		
		const section = document.getElementById('interestSection');
		const btn = document.getElementById('interestBtn');
		const value = document.getElementById('interestValue');
		const countdown = document.getElementById('interestCountdown');

		section.classList.add('inactive');
		btn.classList.add('activate');
		btn.textContent = 'å¼€å¯ç”Ÿæ¯';
		
		if (value) {
			value.innerHTML = '-- æœªå¼€å¯ --';
			
			value.style.cssText = `
				font-size: 22px;
				font-weight: 700;
				color: rgba(255, 255, 255, 0.4);
				font-family: 'Courier New', monospace;
				display: inline;
				text-shadow: none;
				line-height: normal;
			`;
		}
		
		if (countdown) {
			countdown.style.display = 'none';
		}
		
		const input = document.getElementById('resonateInput');
		if (input) {
			input.addEventListener('input', (e) => {
				let value = e.target.value;
				value = value.replace(/[^\d.]/g, '');
				const parts = value.split('.');
				if (parts.length > 2) {
					value = parts[0] + '.' + parts.slice(1).join('');
				}
				if (value.startsWith('.')) {
					value = '0' + value;
				}
				const decimalParts = value.split('.');
				if (decimalParts.length > 1 && decimalParts[1].length > 8) {
					value = decimalParts[0] + '.' + decimalParts[1].substring(0, 8);
				}
				e.target.value = value;
			});
			
			input.addEventListener('paste', (e) => {
				e.preventDefault();
				const pastedText = e.clipboardData.getData('text');
				const cleaned = pastedText.replace(/[^\d.]/g, '');
				const start = e.target.selectionStart;
				const end = e.target.selectionEnd;
				const value = e.target.value;
				e.target.value = value.substring(0, start) + cleaned + value.substring(end);
				e.target.dispatchEvent(new Event('input'));
			});
		}
		
		switchTab('VID');
	}

    window.addEventListener('load', initPage);
    
    window.addEventListener('beforeunload', () => {
        if (window.interestUpdateInterval) {
            clearInterval(window.interestUpdateInterval);
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('referrerInput');
        if (input) {
            input.addEventListener('input', updateInputActionBtn);
        }
    });
    </script>
</body>
</html>
